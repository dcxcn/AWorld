!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).ammowker={})}(this,function(i){"use strict";var M={T:[],Q:[],V3:[],M3:[],torad:Math.PI/180,todeg:180/Math.PI,clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},eulerToQuadArray:function(t,e){e&&(t=M.vectomult(t,M.torad));var i=M.quaternion().setFromEuler(t),o=i.toArray();return i.free(),o},getLength:function(){return"T:"+M.T.length+" Q:"+M.Q.length+" V:"+M.V3.length},destroy:function(){for(;0<M.T.length;)Ammo.destroy(M.T.pop());for(;0<M.Q.length;)Ammo.destroy(M.Q.pop());for(;0<M.V3.length;)Ammo.destroy(M.V3.pop());M.M3=[]},transform:function(){return 0<M.T.length?M.T.pop():new Ammo.btTransform},freeTransform:function(t){M.T.push(t)},quaternion:function(){return 0<M.Q.length?M.Q.pop():new Ammo.btQuaternion},freeQuaternion:function(t){M.Q.push(t)},vector3:function(){return 0<M.V3.length?M.V3.pop():new Ammo.btVector3},freeVector3:function(t){M.V3.push(t)},matrix3:function(){return 0<M.M3.length?M.M3.pop():new t},freeMatrix3:function(t){M.M3.push(t)},vectomult:function(t,e){return t=t.map(function(t){return t*e})},distanceArray:function(t,e){var i=e[0]-t[0],o=e[1]-t[1],s=e[2]-t[2];return Math.sqrt(i*i+o*o+s*s)}};function t(){this.elements=[1,0,0,0,1,0,0,0,1]}Object.assign(t.prototype,{set:function(t,e,i,o,s,r,a,n,l){var c=this.elements;return c[0]=t,c[1]=o,c[2]=a,c[3]=e,c[4]=s,c[5]=n,c[6]=i,c[7]=r,c[8]=l,this},setV3:function(t,e,i){var o=this.elements;return o[0]=t.x(),o[3]=t.y(),o[6]=t.z(),o[1]=e.x(),o[4]=e.y(),o[7]=e.z(),o[2]=i.x(),o[5]=i.y(),o[8]=i.z(),this},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},fromArray:function(t,e){void 0===e&&(e=0);for(var i=0;i<9;i++)this.elements[i]=t[i+e];return this},multiply:function(t){var e=this.row(0),i=this.row(1),o=this.row(2),s=t.column(0),r=t.column(1),a=t.column(2),n=this.elements;return n[0]=e.dot(s),n[1]=e.dot(r),n[2]=e.dot(a),n[3]=i.dot(s),n[4]=i.dot(r),n[5]=i.dot(a),n[6]=o.dot(s),n[7]=o.dot(r),n[8]=o.dot(a),e.free(),i.free(),o.free(),s.free(),r.free(),a.free(),this},multiplyByVector3:function(t){var e=this.row(0),i=this.row(1),o=this.row(2),s=M.vector3().set(e.dot(t),i.dot(t),o.dot(t));return e.free(),i.free(),o.free(),s},toQuaternion:function(){var t,e,i,o,s,r=this.elements,a=r[0]+r[4]+r[8];return o=0<a?(s=.25*(t=2*Math.sqrt(a+1)),e=(r[7]-r[5])/t,i=(r[2]-r[6])/t,(r[3]-r[1])/t):r[4]<r[0]&&r[8]<r[0]?(s=(r[7]-r[5])/(t=2*Math.sqrt(1+r[0]-r[4]-r[8])),e=.25*t,i=(r[1]+r[3])/t,(r[2]+r[6])/t):r[8]<r[4]?(s=(r[2]-r[6])/(t=2*Math.sqrt(1+r[4]-r[0]-r[8])),e=(r[1]+r[3])/t,i=.25*t,(r[5]+r[7])/t):(s=(r[3]-r[1])/(t=2*Math.sqrt(1+r[8]-r[0]-r[4])),e=(r[2]+r[6])/t,i=(r[5]+r[7])/t,.25*t),M.quaternion().set(e,i,o,s)},row:function(t){var e=this.elements,i=3*t;return M.vector3().set(e[i],e[1+i],e[2+i])},column:function(t){var e=this.elements;return M.vector3().set(e[t],e[t+3],e[t+6])},free:function(){M.freeMatrix3(this)}});var o,s,r,e,a,n,u,l,c,m,h,p,d,f,y,v,g,b,A,w,_,S,x,k,z,C,O,T,V,F,D,R,j,I={Ar:null,ArPos:null,constraintDebug:!1,matrix:[],force:[],option:[],flow:{ray:[],terrain:[],vehicle:[]},world:null,gravity:null,scale:1,invscale:1,angle:0,key:[0,0,0,0,0,0,0,0],post:null,makeShape:null},q=new Map;function W(){this.ID=0,this.solids=[],this.bodys=[],this.trans=new Ammo.btTransform,this.zero=new Ammo.btVector3,this.zero.set(0,0,0)}function B(){this.ID=0,this.joints=[],this.t1=new Ammo.btTransform,this.t2=new Ammo.btTransform}function L(){this.ID=0,this.softs=[]}function P(){this.ID=0,this.terrains=[]}function H(t,e){var i=M.transform(),o=M.vector3();this.needsUpdate=!1,this.data=null,this.tmpData=null,this.dataHeap=null,this.type="terrain",1!==I.scale&&(e.pos=M.vectomult(e.pos,I.invScale),e.size=M.vectomult(e.size,I.invScale));var s=void 0===e.size?[1,1,1]:e.size,r=void 0===e.sample?[64,64]:e.sample,a=void 0===e.pos?[0,0,0]:e.pos,n=void 0===e.quat?[0,0,0,1]:e.quat,l=void 0===e.mass?0:e.mass,c=void 0===e.margin?.02:e.margin,m=void 0===e.friction?.5:e.friction,h=void 0===e.restitution?0:e.restitution,p=void 0===e.flag?1:e.flag,d=void 0===e.heightScale?1:e.heightScale,f=void 0===e.upAxis?1:e.upAxis,u=e.hdt||"PHY_FLOAT",y=void 0!==e.flipEdge&&e.flipEdge;this.setData(e.heightData),this.update();var v=new Ammo.btHeightfieldTerrainShape(r[0],r[1],this.data,d,-s[1],s[1],f,u,y);o.set(s[0]/r[0],1,s[2]/r[1]),v.setLocalScaling(o),v.setMargin(c),i.identity().fromArray(a.concat(n)),o.set(0,0,0);var g=new Ammo.btDefaultMotionState(i),b=new Ammo.btRigidBodyConstructionInfo(l,g,v,o);b.set_m_friction(m),b.set_m_restitution(h);var A=new Ammo.btRigidBody(b);A.setCollisionFlags(p),this.name=A.name=t,this.body=A,Ammo.destroy(b),i.free(),o.free(),e=null}function E(){this.ID=0,this.cars=[],this.trans=new Ammo.btTransform}function G(t,e,i){this.name=t,this.chassis=null,this.body=null,this.steering=0,this.breaking=0,this.motor=0,this.gearRatio=[-1,0,2.3,1.8,1.3,.9,.5],this.limitAngular=[1,1,1],this.transforms=[],this.wheelBody=[],this.wheelJoint=[],this.wheelRadius=[],this.isRay=!0,this.data={mass:100,wMass:1,wWidth:.25,nWheel:e.nWheel||4,wPos:[1,0,1.6],engine:1e3,acceleration:10,maxSteering:24*M.torad,breaking:100,incSteering:.04,pos:[0,0,0],quat:[0,0,0,1],massCenter:[0,-.6,0],friction:.6,restitution:.1,linear:0,angular:0,rolling:0,autoSuspension:!1,compValue:.2,dampValue:.3,s_stiffness:20,s_compression:2.3,s_damping:4.4,s_travel:5,s_force:6e3,s_length:.2,w_friction:10.5,w_roll:.001},this.init(e,i)}function Q(){this.ID=0,this.heroes=[]}function U(t,e){this.type="character",this.name=t,this.body=null,this.controller=null,this.angle=0,this.speed=0,this.wasJumping=!1,this.verticalVelocity=0,this.angleInc=.1,this.q=new Ammo.btQuaternion,this.position=new Ammo.btVector3,this.init(e)}function J(){this.ID=0,this.pairs=[]}function X(t,e,i){this.name=i,this.result=0,this.type="collision",this.pa=[0,0,0],this.pb=[0,0,0],this.nb=[0,0,0],this.distance=0,this.impulse=0,this.maxImpulse=0,this.a=t,this.b=e,this.f=new Ammo.ConcreteContactResultCallback,this.f.addSingleResult=function(){this.result=1}.bind(this)}function Y(){this.ID=0,this.rays=[],this.ray=null,this.results=[]}function Z(t,e){this.name=t,this.type="ray",this.precision=1,this.update(e),this.result={hit:!1,name:"",point:[0,0,0],normal:[0,0,0]}}Object.assign(W.prototype,{step:function(i,o){var s,r=this.trans,a=I.scale;this.bodys.forEach(function(t,e){i[s=o+8*e]=9.8*t.getLinearVelocity().length(),t.getMotionState().getWorldTransform(r),r.toArray(i,s+1,a)})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(t){"solid"===t.type?I.world.removeCollisionObject(t):I.world.removeRigidBody(t),Ammo.destroy(t),q.delete(t.name)},remove:function(t){if(q.has(t)){var e=q.get(t),i="solid"===e.type,o=i?this.solids.indexOf(e):this.bodys.indexOf(e);-1!=o&&(i?this.solids.splice(o,1):this.bodys.splice(o,1),this.destroy(e))}},add:function(t,e){var i=void 0!==t.name?t.name:"body"+this.ID++;this.remove(i),void 0!==t.density&&(t.mass=t.density),void 0!==t.bounce&&(t.restitution=t.bounce);var o=void 0===t.mass?0:t.mass,s=t.kinematic||!1,r=t.ghost||!1;r&&(o=0);var a=M.vector3(),n=M.vector3(),l=M.vector3(),c=M.vector3(),m=M.vector3(),h=M.transform(),p=void 0!==t.noMesh&&t.noMesh;s&&(t.flag=2,t.state=4,void 0===t.group&&(t.group=4)),t.size=void 0===t.size?[1,1,1]:t.size,t.pos=void 0===t.pos?[0,0,0]:t.pos,t.quat=void 0===t.quat?[0,0,0,1]:t.quat,1!==I.scale&&(t.pos=M.vectomult(t.pos,I.invScale),t.size=M.vectomult(t.size,I.invScale),void 0!==t.masscenter&&(t.masscenter=M.vectomult(t.masscenter,I.invScale)));var d=null;switch("hardbox"!==t.type&&"hardbox"!==t.type&&"realhardbox"!==t.type&&"ChamferBox"!==t.type||(t.type="box"),"realcylinder"!==t.type&&"ChamferCyl"!==t.type||(t.type="cylinder"),"realcone"===t.type&&(t.type="cone"),"realsphere"===t.type&&(t.type="sphere"),t.type){case"plane":m.fromArray(t.dir||[0,1,0]),d=new Ammo.btStaticPlaneShape(m,0);break;case"box":m.setValue(.5*t.size[0],.5*t.size[1],.5*t.size[2]),d=new Ammo.btBoxShape(m);break;case"sphere":d=new Ammo.btSphereShape(t.size[0]);break;case"cylinder":m.setValue(t.size[0],.5*t.size[1],.5*t.size[2]),d=new Ammo.btCylinderShape(m);break;case"cone":d=new Ammo.btConeShape(t.size[0],.5*t.size[1]);break;case"capsule":d=new Ammo.btCapsuleShape(t.size[0],t.size[1]);break;case"compound":d=new Ammo.btCompoundShape;for(var f,u,y=M.transform(),v=0;v<t.shapes.length;v++){switch((f=t.shapes[v]).quat=void 0===f.quat?[0,0,0,1]:f.quat,1!==I.scale&&(f.pos=M.vectomult(f.pos,I.invScale),f.size=M.vectomult(f.size,I.invScale)),y.identity().fromArray(f.pos.concat(f.quat)),f.type){case"box":m.setValue(.5*f.size[0],.5*f.size[1],.5*f.size[2]),u=new Ammo.btBoxShape(m);break;case"sphere":u=new Ammo.btSphereShape(f.size[0]);break;case"cylinder":m.setValue(f.size[0],.5*f.size[1],.5*f.size[2]),u=new Ammo.btCylinderShape(m);break;case"cone":u=new Ammo.btConeShape(f.size[0],.5*f.size[1]);break;case"capsule":u=new Ammo.btCapsuleShape(f.size[0],f.size[1]);break;case"convex":u=new Ammo.btConvexHullShape;v=0;for(var g=(A=f.v).length;v<g;v+=3)A[v]*=f.size[0],A[v+1]*=f.size[1],A[v+2]*=f.size[2],m.fromArray(A,v),u.addPoint(m)}d.addChildShape(y,u)}y.free();break;case"mesh":var b=new Ammo.btTriangleMesh;for(v=0,g=(A=t.v).length;v<g;v+=9)n.set(A[v+0]*t.size[0],A[v+1]*t.size[1],A[v+2]*t.size[2]),l.set(A[v+3]*t.size[0],A[v+4]*t.size[1],A[v+5]*t.size[2]),c.set(A[v+6]*t.size[0],A[v+7]*t.size[1],A[v+8]*t.size[2]),b.addTriangle(n,l,c,!0);d=0===o?new Ammo.btBvhTriangleMeshShape(b,!0,!0):new Ammo.btConvexTriangleMeshShape(b,!0);break;case"convex":d=new Ammo.btConvexHullShape;var A;for(v=0,g=(A=t.v).length;v<g;v+=3)A[v]*=t.size[0],A[v+1]*=t.size[1],A[v+2]*=t.size[2],m.fromArray(A,v),d.addPoint(m);t.optimized&&(d.recalcLocalAabb(),d.initializePolyhedralFeatures())}if(void 0!==d.setMargin&&"sphere"!==t.type&&"capsule"!==t.type&&"compound"!==t.type&&(void 0!==t.margin?d.setMargin(t.margin*I.invScale):void 0!==d.getMargin&&1!==I.scale&&d.setMargin(d.getMargin()*I.invScale)),"isShape"==e)return d;if(h.identity().fromArray(t.pos.concat(t.quat)),t.bonePos){var w=M.vector3().fromArray(t.bonePos).multiplyScalar(I.invScale),_=M.transform();_.identity(),_.setOrigin(w),h.multiply(_),_.free()}if("isGhost"==e){var S=new Ammo.btGhostObject;return S.setCollisionShape(d),S.setCollisionFlags(t.flag||4),S.setWorldTransform(h),S}n.setValue(0,0,0),0!==o&&d.calculateLocalInertia(o,n);var x,k=new Ammo.btDefaultMotionState(h),z=new Ammo.btRigidBodyConstructionInfo(o,k,d,n);if(void 0!==t.friction&&z.set_m_friction(t.friction),void 0!==t.restitution&&z.set_m_restitution(t.restitution),void 0!==t.linear&&z.set_m_linearDamping(t.linear),void 0!==t.angular&&z.set_m_angularDamping(t.angular),void 0!==t.rolling&&z.set_m_rollingFriction(t.rolling),t.masscenter){a.fromArray(t.masscenter).negate(),h.setIdentity(),h.setOrigin(a),(x=new Ammo.btCompoundShape).addChildShape(h,d),h.identity().fromArray(t.pos.concat(t.quat)),a.setValue(0,0,0),x.calculateLocalInertia(o,a);k=new Ammo.btDefaultMotionState(h),z=new Ammo.btRigidBodyConstructionInfo(o,k,x,a)}else r?((x=new Ammo.btGhostObject).setCollisionShape(d),x.setWorldTransform(h),t.flag=t.flag||4,x.setCollisionFlags(t.flag),x.isGhost=!0):(x=new Ammo.btRigidBody(z),s&&(x.isKinematic=!0));x.name=i,0!==o||s?(x.setCollisionFlags(t.flag||0),x.setActivationState(t.state||1),t.neverSleep&&x.setSleepingThresholds(0,0),I.world.addRigidBody(x,t.group||1,t.mask||-1),p?(x.type="body",this.solids.push(x)):(x.type="body",this.bodys.push(x))):(x.setCollisionFlags(t.flag||1),I.world.addCollisionObject(x,t.group||2,t.mask||-1),x.type="solid",this.solids.push(x)),x.breakable=void 0!==t.breakable&&t.breakable,x.breakable&&(x.breakOption=void 0!==t.breakOption?t.breakOption:[250,1,2,1]),q.set(i,x),Ammo.destroy(z),this.applyOption(x,t),h.free(),a.free(),n.free(),l.free(),c.free(),m.free(),t=null},applyOption:function(t,e){var i=M.vector3();if(void 0!==e.flag&&(t.setCollisionFlags(e.flag),t.isKinematic=2===e.flag),void 0!==e.state&&t.setActivationState(e.state),void 0!==e.activate&&t.activate(),t.isGhost||(void 0!==e.group&&t.getBroadphaseProxy().set_m_collisionFilterGroup(e.group),void 0!==e.mask&&t.getBroadphaseProxy().set_m_collisionFilterMask(e.mask),void 0!==e.damping&&t.setDamping(e.damping[0],e.damping[1]),void 0!==e.sleeping&&t.setSleepingThresholds(e.sleeping[0],e.sleeping[1])),void 0!==e.friction&&t.setFriction(e.friction),void 0!==e.restitution&&t.setRestitution(e.restitution),void 0!==e.rollingFriction&&t.setRollingFriction(e.rollingFriction),void 0!==e.linearVelocity&&t.setLinearVelocity(i.fromArray(e.linearVelocity,0,I.invScale)),void 0!==e.angularVelocity&&t.setAngularVelocity(i.fromArray(e.angularVelocity)),void 0!==e.linearFactor&&t.setLinearFactor(i.fromArray(e.linearFactor)),void 0!==e.angularFactor&&t.setAngularFactor(i.fromArray(e.angularFactor)),void 0!==e.anisotropic&&t.setAnisotropicFriction(e.anisotropic[0],e.anisotropic[1]),void 0!==e.massProps&&t.setMassProps(e.massProps[0],e.massProps[1]),void 0!==e.gravity&&t.setGravity(e.gravity?I.gravity:this.zero),void 0!==e.ccdThreshold&&t.setCcdMotionThreshold(e.ccdThreshold),void 0!==e.ccdRadius&&t.setCcdSweptSphereRadius(e.ccdRadius),e.trans){var o=M.transform();if(o.identity().fromArray(e.trans),e.mmdPos){var s=M.transform();s.identity().fromArray(e.mmdPos.concat(e.mmdQuat)),o.multiply(s),s.free()}t.setCenterOfMassTransform(o),t.getMotionState().setWorldTransform(o),o.free()}i.free()}}),Object.assign(B.prototype,{step:function(i,o){var s,r=this.t1,a=this.t2,n=I.scale;this.joints.forEach(function(t,e){s=o+14*e,r.copy(q.get(t.b1).getWorldTransform()).multiply(t.formA).toArray(i,s,n),a.copy(q.get(t.b2).getWorldTransform()).multiply(t.formB).toArray(i,s+7,n)})},clear:function(){for(;0<this.joints.length;)this.destroy(this.joints.pop());this.ID=0},destroy:function(t){I.world.removeConstraint(t),t.formA.free(),t.formB.free(),Ammo.destroy(t),q.delete(t.name)},remove:function(t){if(q.has(t)){var e=q.get(t),i=this.joints.indexOf(e);-1!=i&&(this.joints.splice(i,1),this.destroy(e))}},add:function(t){t.name=void 0!==t.name?t.name:"joint"+this.ID++;var e=t.name;if(this.remove(e),t.body1&&(t.b1=t.body1),t.body2&&(t.b2=t.body2),q.has(t.b1)&&q.has(t.b2)){var i=q.get(t.b1),o=q.get(t.b2);i.activate(),o.activate();var s=M.vector3(),r=M.vector3().fromArray(t.pos1||[0,0,0]).multiplyScalar(I.invScale),a=M.vector3().fromArray(t.pos2||[0,0,0]).multiplyScalar(I.invScale),n=M.vector3().fromArray(t.axe1||[1,0,0]),l=M.vector3().fromArray(t.axe2||[1,0,0]),c=M.transform().identity(),m=M.transform().identity();if("joint_p2p"!==t.type&&"joint_hinge"!==t.type&&"joint"!==t.type)if(void 0===t.local||t.local)c.setOrigin(r),void 0!==t.quat1?c.quaternionFromArray(t.quat1):t.axe1&&c.quartenionFromAxis(t.axe1),m.setOrigin(a),void 0!==t.quat2?m.quaternionFromArray(t.quat2):t.axe2&&m.quartenionFromAxis(t.axe2);else{var h=M.transform();h.identity().fromArray(t.pos1.concat(t.quat1)),i.getMotionState().getWorldTransform(c),c=c.getInverse().multiply(h),h.identity().fromArray(t.pos2.concat(t.quat2)),o.getMotionState().getWorldTransform(m),m=m.getInverse().multiply(h),h.free()}var p,d,f=void 0===t.useA||t.useA;switch(t.type){case"joint_p2p":d=1,p=new Ammo.btPoint2PointConstraint(i,o,r,a),t.strength&&p.get_m_setting().set_m_tau(t.strength),t.damping&&p.get_m_setting().set_m_damping(t.damping),t.impulse&&p.get_m_setting().set_m_impulseClamp(t.impulse);break;case"joint_hinge":case"joint":d=2,p=new Ammo.btHingeConstraint(i,o,r,a,n,l,f);break;case"joint_hinge_ref":d=2,p=new Ammo.btHingeConstraint(i,o,c,m,f);break;case"joint_slider":d=3,p=new Ammo.btSliderConstraint(i,o,c,m,f);break;case"joint_conetwist":d=4,p=new Ammo.btConeTwistConstraint(i,o,c,m);break;case"joint_dof":d=5,p=new Ammo.btGeneric6DofConstraint(i,o,c,m,f);break;case"joint_spring_dof":d=6,p=new Ammo.btGeneric6DofSpringConstraint(i,o,c,m,f);break;case"joint_fixe":d=7,p=new Ammo.btFixedConstraint(i,o,c,m)}if(p.b1=t.b1,p.b2=t.b2,p.formA=c.clone(),p.formB=m.clone(),t.breaking&&p.setBreakingImpulseThreshold&&p.setBreakingImpulseThreshold(t.breaking),t.limit&&p.setLimit&&("joint_hinge"!==t.type&&"joint"!==t.type&&"joint_hinge_ref"!==t.type||p.setLimit(t.limit[0]*M.torad,t.limit[1]*M.torad,void 0!==t.limit[2]?t.limit[2]:.9,void 0!==t.limit[3]?t.limit[3]:.3,void 0!==t.limit[4]?t.limit[4]:1),"joint_conetwist"===t.type&&(p.setLimit(3,t.limit[2]*M.torad),p.setLimit(4,t.limit[1]*M.torad),p.setLimit(5,t.limit[0]*M.torad))),t.limit&&"joint_slider"===t.type&&(t.limit[0]&&p.setLowerLinLimit(t.limit[0]*I.invScale),t.limit[1]&&p.setUpperLinLimit(t.limit[1]*I.invScale),t.limit[2]&&p.setLowerAngLimit(t.limit[2]*M.torad),t.limit[3]&&p.setUpperAngLimit(t.limit[3]*M.torad)),p.setLinearLowerLimit&&(t.linLower&&p.setLinearLowerLimit(s.fromArray(t.linLower).multiplyScalar(I.invScale)),t.linUpper&&p.setLinearUpperLimit(s.fromArray(t.linUpper).multiplyScalar(I.invScale))),p.setAngularLowerLimit&&(t.angLower&&p.setAngularLowerLimit(s.fromArray(t.angLower).multiplyScalar(M.torad)),t.angUpper&&p.setAngularUpperLimit(s.fromArray(t.angUpper).multiplyScalar(M.torad))),t.motor&&p.enableAngularMotor&&p.enableAngularMotor(t.motor[0],t.motor[1],t.motor[2]),t.feedback&&p.enableFeedback(t.feedback),t.angularOnly&&p.setAngularOnly&&p.setAngularOnly(t.angularOnly?1:0),t.enableMotor&&p.enableMotor&&p.enableMotor(t.enableMotor),t.maxMotorImpulse&&p.setMaxMotorImpulse&&p.setMaxMotorImpulse(t.maxMotorImpulse),t.motorTarget&&p.setMotorTarget){var u=M.quaternion().fromArray(t.motorTarget);p.setMotorTarget(u),u.free()}if(t.damping&&p.setDamping)for(var y=0;y<6;y++)p.setDamping(y,t.damping[y]);if(t.spring&&p.enableSpring&&p.setStiffness){for(y=0;y<3;y++)0!==t.spring[y]?(p.enableSpring(y,!0),p.setStiffness(y,t.spring[y])):p.enableSpring(y,!1);for(y=0;y<3;y++)0!==t.spring[y]?(p.enableSpring(y+3,!0),p.setStiffness(y+3,t.spring[y])):p.enableSpring(y+3,!1)}if(t.param&&p.setParam){y=0;for(var v=t.param.length;y<v;y++)p.setParam(t.param[y][0],t.param[y][1],y)}var g=void 0!==t.collision&&t.collision;p.isJoint=!0,p.name=e,p.nType=d,p.type="joint",I.world.addConstraint(p,!g),this.joints.push(p),q.set(e,p),s.free(),r.free(),a.free(),n.free(),l.free(),c.free(),m.free(),t=null}else console.log("! not find body")},applyOption:function(t,e){"joint_hinge"===e.type&&(e.limit&&(t.setLimit(e.limit[0]*M.torad,e.limit[1]*M.torad,void 0!==e.limit[2]?e.limit[2]:.9,void 0!==e.limit[3]?e.limit[3]:.3,void 0!==e.limit[4]?e.limit[4]:1),console.log("applyOption===joint_hinge==="+e.limit)),e.motor&&t.enableAngularMotor&&t.enableAngularMotor(e.motor[0],e.motor[1],e.motor[2]))}}),Object.assign(function(t){this.type="constraint",this.name=t.name}.prototype,{step:function(){},init:function(){},clear:function(){}}),Object.assign(L.prototype,{step:function(e,t){var i,o,s,r=t,a=I.scale;this.softs.forEach(function(t){for(o=t.get_m_nodes(),s=o.size();s--;)i=r+3*s,o.at(s).get_m_x().toArray(e,i,a);r+=3*o.size()})},getNodes:function(t){for(var e=[],i=t.get_m_nodes(),o=i.size(),s=0;s<o;s++)300<i.at(s).get_m_x().toArray()[1]&&e.push(s);return e},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(t){I.world.removeSoftBody(t),Ammo.destroy(t),q.delete(t.name)},remove:function(t){if(q.has(t)){var e=q.get(t),i=this.softs.indexOf(e);-1!=i&&(this.softs.splice(i,1),this.destroy(e))}},addAreo:function(t){if(q.has(t.soft)){for(var e=q.get(t.soft),i=M.vector3().fromeArray(t.wind),o=t.nodes.length;o--;)e.addAeroForceToNode(i,t.nodes[o]);i.free()}},addAnchor:function(t){if(q.has(t.soft)&&q.has(t.body))for(var e=t.collision||!1,i=q.get(t.soft),o=q.get(t.body),s=t.nodes.length;s--;)i.appendAnchor(t.nodes[s],o,!e,t.influence||1)},add:function(t){var e=void 0!==t.name?t.name:"soft"+this.ID++;this.remove(e);var i=I.world.getWorldInfo(),o=t.gendiags||!0;t.size=null==t.size?[1,1,1]:t.size,t.pos=void 0===t.pos?[0,0,0]:t.pos,t.quat=void 0===t.quat?[0,0,0,1]:t.quat,t.div=null==t.div?[64,64]:t.div,1!==I.scale&&(t.pos=M.vectomult(t.pos,I.invScale),t.size=M.vectomult(t.size,I.invScale));var s,r=M.vector3(),a=M.vector3(),n=M.vector3(),l=M.vector3(),c=M.vector3(),m=M.transform(),h=new Ammo.btSoftBodyHelpers;switch(t.type){case"softMesh":if(1!==I.scale)for(var p=t.v.length;p--;)t.v[p]*=I.invScale;(s=h.CreateFromTriMesh(i,t.v,t.i,t.ntri,t.randomize||!0)).softType=5;break;case"softCloth":var d=.5*t.size[0],f=.5*t.size[1];t.corners&&t.corners.enabled?(a.fromArray(t.corners.pos00),n.fromArray(t.corners.pos01),l.fromArray(t.corners.pos10),c.fromArray(t.corners.pos11)):"H"==t.direction.align?(a.fromArray([-d+t.pos[0],t.pos[1],-f+t.pos[2]]),n.fromArray([d+t.pos[0],t.pos[1],-f+t.pos[2]]),l.fromArray([-d+t.pos[0],t.pos[1],f+t.pos[2]]),c.fromArray([d+t.pos[0],t.pos[1],f+t.pos[2]])):"V_T"==t.direction.align?"X"==t.direction.face2?(a.fromArray([t.pos[0],t.pos[1]-f,t.pos[2]-d]),n.fromArray([t.pos[0],t.pos[1]-f,t.pos[2]+d]),l.fromArray([t.pos[0],t.pos[1]+f,t.pos[2]-d]),c.fromArray([t.pos[0],t.pos[1]+f,t.pos[2]+d])):"Z"==t.direction.face2&&(a.fromArray([t.pos[0]-d,t.pos[1]-f,t.pos[2]]),n.fromArray([t.pos[0]+d,t.pos[1]-f,t.pos[2]]),l.fromArray([t.pos[0]-d,t.pos[1]+f,t.pos[2]]),c.fromArray([t.pos[0]+d,t.pos[1]+f,t.pos[2]])):"V_B"==t.direction.align?"X"==t.direction.face2?(a.fromArray([t.pos[0],t.pos[1]+f,t.pos[2]+d]),n.fromArray([t.pos[0],t.pos[1]+f,t.pos[2]-d]),l.fromArray([t.pos[0],t.pos[1]-f,t.pos[2]+d]),c.fromArray([t.pos[0],t.pos[1]-f,t.pos[2]-d])):"Z"==t.direction.face2&&(a.fromArray([t.pos[0]+d,t.pos[1]+f,t.pos[2]]),n.fromArray([t.pos[0]-d,t.pos[1]+f,t.pos[2]]),l.fromArray([t.pos[0]+d,t.pos[1]-f,t.pos[2]]),c.fromArray([t.pos[0]-d,t.pos[1]-f,t.pos[2]])):"V_C"==t.direction.align&&("X"==t.direction.face2?(a.fromArray([t.pos[0],t.pos[1],t.pos[2]]),n.fromArray([t.pos[0],t.pos[1],t.pos[2]-2*d]),l.fromArray([t.pos[0],t.pos[1]-2*f,t.pos[2]]),c.fromArray([t.pos[0],t.pos[1]-2*f,t.pos[2]-2*d])):"Z"==t.direction.face2&&(a.fromArray([t.pos[0],t.pos[1],t.pos[2]]),n.fromArray([t.pos[0]-2*d,t.pos[1],t.pos[2]]),l.fromArray([t.pos[0],t.pos[1]-2*f,t.pos[2]]),c.fromArray([t.pos[0]-2*d,t.pos[1]-2*f,t.pos[2]]))),(s=h.CreatePatch(i,a,n,l,c,t.div[0],t.div[1],t.fixed||0,o)).softType=1;break;case"softRope":a.fromArray(t.start||[-10,0,0],0,I.invScale),n.fromArray(t.end||[10,0,0],0,I.invScale);var u=t.numSegment||10;(s=h.CreateRope(i,a,n,u-=2,t.fixed||0)).softType=2;break;case"softEllips":a.fromArray(t.center||[0,0,0],0,I.invScale),n.fromArray(t.radius||[3,3,3],0,I.invScale),(s=h.CreateEllipsoid(i,a,n,t.vertices||128)).softType=3;var y,v=[],g=s.get_m_nodes();for(p=g.size();p--;)b=3*p,y=g.at(p).get_m_x(),v[b]=y.x(),v[b+1]=y.y(),v[b+2]=y.z();t.lng=g.size(),t.a=v,self.postMessage({m:"ellipsoid",o:t});break;case"softConvex":var b,A=t.v.length/3,w=0;for(w=0;w<A;w++)b=3*w;var _=new Ammo.btConvexHullShape;for(w=0;w<A;w++)a.fromArray(t.v,b=3*w,I.invScale),_.addPoint(a);_.initializePolyhedralFeatures(),(s=h.CreateFromConvexHull(i,_.getConvexPolyhedron(),_.getConvexPolyhedron().m_vertices.size(),t.randomize||!1)).softType=4,console.log(s,s.get_m_nodes().size())}this.applyOption(s,t),m.identity().fromArray(t.pos.concat(t.quat)),s.transform(m),I.world.addSoftBody(s,t.group||1,t.mask||-1),s.setActivationState(t.state||4),s.points=s.get_m_nodes().size(),s.name=e,s.type="soft",this.softs.push(s),q.set(e,s),r.free(),a.free(),n.free(),l.free(),c.free(),m.free(),t=null},applyOption:function(t,e){var i=t.get_m_cfg();void 0!==e.viterations&&i.set_viterations(e.viterations),void 0!==e.piterations&&i.set_piterations(e.piterations),void 0!==e.diterations&&i.set_diterations(e.diterations),void 0!==e.citerations&&i.set_citerations(e.citerations),i.set_collisions(17),void 0!==e.friction&&i.set_kDF(e.friction),void 0!==e.damping&&i.set_kDP(e.damping),void 0!==e.pressure&&i.set_kPR(e.pressure),void 0!==e.drag&&i.set_kDG(e.drag),void 0!==e.lift&&i.set_kLF(e.lift),void 0!==e.volume&&i.set_kVC(e.volume),void 0!==e.matching&&i.set_kMT(e.matching),void 0!==e.hardness&&(i.set_kCHR(e.hardness),i.set_kKHR(e.hardness),i.set_kSHR(e.hardness),i.set_kAHR(e.hardness)),void 0!==e.timescale&&i.set_timescale(e.timescale),void 0!==e.maxvolume&&i.set_maxvolume(e.maxvolume);var o=t.get_m_materials().at(0);void 0!==e.stiffness&&(o.set_m_kLST(e.stiffness),o.set_m_kAST(e.stiffness),o.set_m_kVST(e.stiffness)),void 0!==e.bendingConstraint&&t.generateBendingConstraints(e.bendingConstraint,o),t.setTotalMass(e.mass||0,e.fromfaces||!1),void 0!==e.cluster&&t.generateClusters(e.cluster,e.maxClusterIterations||8192),void 0!==e.restitution&&t.setRestitution(e.restitution),void 0!==e.rolling&&t.setRollingFriction(e.rolling),void 0!==e.flag&&t.setCollisionFlags(e.flag),void 0!==e.margin&&Ammo.castObject(t,Ammo.btCollisionObject).getCollisionShape().setMargin(e.margin*I.invScale)}}),Object.assign(P.prototype,{step:function(){for(var t=I.flow.terrain.length;t--;)this.setData(I.flow.terrain[t]);I.flow.terrain=[],this.terrains.forEach(function(t){t.update()})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());this.ID=0},destroy:function(t){I.world.removeCollisionObject(t.body),t.clear(),q.delete(t.name)},remove:function(t){if(q.has(t)){var e=q.get(t),i=this.terrains.indexOf(e);-1!=i&&(this.terrains.splice(i,1),this.destroy(e))}},setData:function(t){q.has(t.name)&&q.get(t.name).setData(t.heightData)},add:function(t){var e=void 0!==t.name?t.name:"terrain"+this.ID++;this.remove(e);var i=void 0===t.group?2:t.group,o=void 0===t.mask?-1:t.mask,s=new H(e,t);I.world.addCollisionObject(s.body,i,o),this.terrains.push(s),q.set(e,s)}}),Object.assign(H.prototype,{setData:function(t){this.tmpData=t,this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT,this.needsUpdate=!0},update:function(){this.needsUpdate&&(this.malloc(),this.needsUpdate=!1,this.tmpData=null)},clear:function(){Ammo.destroy(this.body),Ammo._free(this.dataHeap.byteOffset),this.body=null,this.data=null,this.tmpData=null,this.dataHeap=null},malloc:function(){null===this.data&&(this.data=Ammo._malloc(this.nDataBytes)),this.dataHeap=new Uint8Array(Ammo.HEAPU8.buffer,this.data,this.nDataBytes),this.dataHeap.set(new Uint8Array(this.tmpData.buffer))}}),Object.assign(E.prototype,{step:function(i,o){for(var t=I.flow.vehicle.length;t--;)this.setData(I.flow.vehicle[t]);I.flow.vehicle=[];var s=this.trans;this.cars.forEach(function(t,e){t.step(i,o+64*e,s),t.drive(I.key[e])})},control:function(t){q.has(t)&&q.get(t+"_constuctor").drive(I.key)},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(t){I.world.removeRigidBody(t.body),I.world.removeAction(t.chassis),Ammo.destroy(t.body),Ammo.destroy(t.chassis),q.delete(t.name+"_constuctor"),q.delete(t.name),q.delete(t.name+"_chassis")},remove:function(t){if(q.has(t)){var e=q.get(t),i=this.cars.indexOf(e);-1!=i&&(this.cars.splice(i,1),this.destroy(e))}},setData:function(t){q.has(t.name+"_constuctor")&&q.get(t.name+"_constuctor").setData(t)},add:function(t){var e=void 0!==t.name?t.name:"car"+this.ID++;this.remove(e),t.size=void 0===t.size?[2,.5,4]:t.size,void 0!==t.pos&&(t.pos=M.vectomult(t.pos,I.invScale)),void 0!==t.size&&(t.size=M.vectomult(t.size,I.invScale)),void 0!==t.massCenter&&(t.massCenter=M.vectomult(t.massCenter,I.invScale));var i=t.shapeType||"box",o=I.makeShape("mesh"==i?{type:"mesh",v:t.v,mass:1}:"convex"==i?{type:"convex",v:t.v}:{type:"box",size:t.size});void 0!==t.v&&delete t.v;var s=new G(e,t,o);I.world.addAction(s.chassis),I.world.addRigidBody(s.body),this.cars.push(s),q.set(e+"_constuctor",s),q.set(e,s.body),q.set(e+"_chassis",s.chassis)},applyOption:function(){}}),Object.assign(G.prototype,{step:function(t,e,i){var o=I.scale;t[e]=this.chassis.getCurrentSpeedKmHour(),this.body.getMotionState().getWorldTransform(i),i.toArray(t,e+1,o);for(var s,r,a=this.data.nWheel;a--;)this.chassis.updateWheelTransform(a,!0),r=this.chassis.getWheelTransformWS(a),t[e+56+a]=this.chassis.getWheelInfo(a).get_m_raycastInfo().get_m_suspensionLength()*o,r.toArray(t,e+(s=8*(a+1))+1,o),0===a&&(t[e+s]=this.chassis.getWheelInfo(0).get_m_steering()),1===a&&(t[e+s]=this.chassis.getWheelInfo(1).get_m_steering()),2===a&&(t[e+s]=this.steering);t[e+62]=this.chassis.getWheelInfo(0).m_rotation,t[e+63]=this.chassis.getWheelInfo(1).m_rotation},drive:function(t){var e=this.data;if(0===t[0]?this.steering*=.9:this.steering-=e.incSteering*t[0],this.steering=M.clamp(this.steering,-e.maxSteering,e.maxSteering),0===t[1]?(this.motor=0,this.breaking=e.breaking):(this.motor-=e.acceleration*t[1],this.breaking=0),this.motor=M.clamp(this.motor,-e.engine,e.engine),3<e.nWheel){var i=2*this.wpos[2],o=this.wpos[0],s=i/Math.tan(this.steering),r=Math.atan2(i,o+s),a=Math.atan2(i,s-o);s<0&&(r-=Math.PI,a-=Math.PI)}for(var n=e.nWheel;n--;)e.nWheel<4?0===n&&this.chassis.setSteeringValue(this.steering,n):(0===n&&this.chassis.setSteeringValue(a,n),1===n&&this.chassis.setSteeringValue(r,n)),this.chassis.applyEngineForce(this.motor,n),this.chassis.setBrake(this.breaking,n);if(this.motor<1){var l=this.body.getAngularVelocity();l.multiplyArray(this.limitAngular),this.body.setAngularVelocity(l)}},clear:function(){this.body=null,this.chassis=null},init:function(t,e){var i=this.data,o=M.transform(),s=M.vector3(),r=M.vector3(),a=M.vector3(),n=M.vector3();this.isRay=void 0===t.isRay||t.isRay,i.mass=void 0===t.mass?800:t.mass,t.massCenter=void 0===t.massCenter?[0,0,0]:t.massCenter,i.pos=void 0===t.pos?[0,0,0]:t.pos,i.quat=void 0===t.quat?[0,0,0,1]:t.quat,i.nWheel=t.nWheel||4,s.fromArray(t.massCenter).negate(),o.setIdentity(),o.setOrigin(s);var l=new Ammo.btCompoundShape;l.addChildShape(o,e),o.identity().fromArray(i.pos.concat(i.quat)),s.setValue(0,0,0),l.calculateLocalInertia(i.mass,s);var c=new Ammo.btDefaultMotionState(o),m=new Ammo.btRigidBodyConstructionInfo(i.mass,c,l,s);if(this.body=new Ammo.btRigidBody(m),this.body.name=this.name,this.body.isRigidBody=!0,this.body.isBody=!0,this.body.setActivationState(4),Ammo.destroy(m),this.isRay){var h=new Ammo.btVehicleTuning,p=new Ammo.btDefaultVehicleRaycaster(I.world);this.chassis=new Ammo.btRaycastVehicle(h,this.body,p),this.chassis.setCoordinateSystem(0,1,2)}var d=t.radius||.4,f=t.radiusBack||d,u=t.wPos||[1,0,1.6];u=M.vectomult(u,I.invScale),d*=I.invScale,f*=I.invScale,u[1]-=t.massCenter[1];for(var y,v,g=i.nWheel,b=t.decalYBack||0,A=0;A<g;A++)0===A&&(y=[u[0],u[1],u[2]],v=!0),1===A&&(y=[-u[0],u[1],u[2]],v=!0),2===A&&(v=!(y=[-u[0],u[1]+b,-u[2]])),3===A&&(v=!(y=[u[0],u[1]+b,-u[2]])),4===A&&(v=!(y=[-u[0],u[1]+b,-u[3]])),5===A&&(v=!(y=[u[0],u[1]+b,-u[3]])),2===g&&(0===A&&(y=[0,u[1],u[2]],v=!0),1===A&&(v=!(y=[0,u[1]+b,-u[2]]))),3===g&&(0===A&&(y=[0,u[1],u[2]],v=!0),1===A&&(v=!(y=[u[0],u[1]+b,-u[2]])),2===A&&(v=!(y=[-u[0],u[1]+b,-u[2]]))),r.fromArray(y),a.setValue(0,-1,0),n.setValue(-1,0,0),this.chassis.addWheel(r,a,n,1,v?d:f,h,v),this.chassis.setBrake(t.breaking||100,A),this.wheelRadius.push(v?d:f),this.transforms.push(this.chassis.getWheelTransformWS(A));this.wpos=u,this.setData(t),o.free(),s.free(),r.free(),a.free(),n.free()},setMass:function(t){var e=M.vector3();this.data.mass=t,e.setValue(0,0,0),this.body.getCollisionShape().calculateLocalInertia(this.data.mass,e),this.body.setMassProps(t,e),this.body.updateInertiaTensor(),e.free()},setPosition:function(){this.steering=0,this.breaking=0,this.motor=0;var t=M.transform();t.identity().fromArray(this.data.pos.concat(this.data.quat));var e=M.vector3().set(0,0,0);this.body.setAngularVelocity(e),this.body.setLinearVelocity(e),this.body.setWorldTransform(t),this.chassis.resetSuspension();for(var i=this.data.nWheel;i--;)this.chassis.updateWheelTransform(i,!0);t.free(),e.free()},setData:function(t){var e=this.data;for(var i in void 0!==t.mass&&t.mass!==e.mass&&this.setMass(t.mass),t)void 0!==e[i]&&(e[i]=t[i]);this.body.setFriction(e.friction),this.body.setRestitution(e.restitution),this.body.setDamping(e.linear,e.angular),this.body.setRollingFriction(e.rolling),void 0!==t.limitAngular&&(this.limitAngular=t.limitAngular);var o=M.vector3();if(void 0!==t.linearFactor&&this.body.setLinearFactor(o.fromArray(t.linearFactor)),void 0!==t.angularFactor&&this.body.setAngularFactor(o.fromArray(t.angularFactor)),o.free(),e.autoSuspension){var s=Math.sqrt(e.s_stiffness);e.s_compression=2*e.compValue*s,e.s_damping=2*e.dampValue*s}for(var r,a=e.nWheel;a--;)(r=this.chassis.getWheelInfo(a)).set_m_suspensionStiffness(e.s_stiffness),r.set_m_wheelsDampingCompression(e.s_compression),r.set_m_wheelsDampingRelaxation(e.s_damping),r.set_m_maxSuspensionTravelCm(100*e.s_travel*I.invScale),r.set_m_suspensionRestLength1(e.s_length*I.invScale),r.set_m_maxSuspensionForce(e.s_force),r.set_m_rollInfluence(e.w_roll),r.set_m_frictionSlip(e.w_friction),r.set_m_wheelsRadius(this.wheelRadius[a]);t.reset&&this.setPosition()},get:function(){self.postMessage({m:"carData",o:this.data})}}),Object.assign(Q.prototype,{step:function(i,o){this.heroes.forEach(function(t,e){t.step(i,o+8*e),0!=I.key.length&&t.move(I.key[e])})},control:function(t){if(q.has(t)){var e=q.get(t);I.key&&e.move(I.key)}},clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(t){I.world.removeCollisionObject(t.body),I.world.removeAction(t.controller),t.clear(),q.delete(t.name)},remove:function(t){if(q.has(t)){var e=q.get(t),i=this.heroes.indexOf(e);-1!=i&&(this.heroes.splice(i,1),this.destroy(e))}},add:function(t){var e=void 0!==t.name?t.name:"hero"+this.ID++;this.remove(e);var i=new U(e,t);I.world.addCollisionObject(i.body,t.group||1,t.mask||-1),I.world.addAction(i.controller),this.heroes.push(i),q.set(e,i)}}),Object.assign(U.prototype,{isCharacter:!0,step:function(t,e){t[e]=this.controller.onGround()?1:0,this.body.getWorldTransform().toArray(t,e+1,I.scale)},move:function(t){var e,i,o=.05;o=1==t[7]?.1:1==t[5]?.02:.05,1==t[6]&&this.controller.canJump(),!this.wasJumping&&this.controller.onGround()&&(this.verticalVelocity=0,this.wasJumping=1==t[6]),0==t[6]&&this.wasJumping&&(this.verticalVelocity+=.04,.5<this.verticalVelocity&&(this.verticalVelocity=0,this.wasJumping=!1)),this.speed=(i=o*-t[1])+(e=o*-t[4]),this.angle-=.1*t[0],this.setAngle(this.angle),this.position.setValue(e,0+this.verticalVelocity,i),this.position.direction(this.q),this.controller.setWalkDirection(this.position)},clear:function(){Ammo.destroy(this.body),Ammo.destroy(this.controller),this.body=null,this.controller=null},init:function(t){var e=M.vector3(),i=M.transform();t.size=null==t.size?[1,1,1]:t.size,t.pos=null==t.pos?[0,0,0]:t.pos,t.quat=null==t.quat?[0,0,0,1]:t.quat,1!==I.scale&&(t.pos=M.vectomult(t.pos,I.invScale),void 0!==t.masscenter&&(t.masscenter=M.vectomult(t.masscenter,I.invScale)));var o=I.makeShape(t.shapeInfo||{type:"capsule",size:t.size}),s=new Ammo.btPairCachingGhostObject;i.identity().fromArray(t.pos.concat(t.quat)),s.setWorldTransform(i),s.setCollisionShape(o),s.setCollisionFlags(16),s.setFriction(t.friction||.1),s.setRestitution(t.restitution||0),s.setActivationState(4),s.activate(),this.body=s;var r=new Ammo.btKinematicCharacterController(s,o,t.stepH||.35,t.upAxis||1);r.setUseGhostSweepTest(o),e.setValue(0,0,0),r.setVelocityForTimeInterval(e,1),this.controller=r,this.applyOption(t),this.setAngle(0),console.log(r,s)},applyOption:function(t){var e=this.controller;void 0!==t.gravity&&e.setGravity(t.gravity),void 0!==t.upAxis&&e.setUpAxis(t.upAxis),void 0!==t.canJump&&e.canJump(t.canJump),void 0!==t.maxJumpHeight&&e.setMaxJumpHeight(t.maxJumpHeight),void 0!==t.jumpSpeed&&e.setJumpSpeed(t.jumpSpeed),void 0!==t.fallSpeed&&e.setFallSpeed(t.fallSpeed),void 0!==t.slopeRadians&&e.setMaxSlope(t.slopeRadians),void 0!==t.angle&&this.setAngle(t.angle),void 0!==t.position&&(this.position.fromArray(t.position,0,I.invScale),this.position.direction(this.q),e.setWalkDirection(this.position)),void 0!==t.pos&&this.setMatrix(t)},setMatrix:function(t){var e=M.vector3();t.pos=M.vectomult(t.pos,I.invScale),e.fromArray(t.pos),this.controller.warp(e),e.free()},setAngle:function(t){var e=this.body.getWorldTransform();this.q.setFromAxisAngle([0,1,0],t),e.setRotation(this.q),this.angle=t}}),Object.assign(J.prototype,{step:function(i,o){var s;this.pairs.forEach(function(t,e){s=o+e,void(t.result=0)!==t.b?I.world.contactPairTest(t.a,t.b,t.f):I.world.contactTest(t.a,t.f),i[s]=t.result})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());this.ID=0},destroy:function(t){t.clear(),q.delete(t.name)},remove:function(t){if(q.has(t)){var e=q.get(t),i=this.pairs.indexOf(e);-1!=i&&(this.pairs.splice(i,1),this.destroy(e))}},add:function(t){var e=void 0!==t.name?t.name:"pair"+this.ID++;if(q.has(t.b1)){var i=new X(q.get(t.b1),void 0!==t.b2&&q.has(t.b2)?q.get(t.b2):void 0,e);this.pairs.push(i),q.set(e,i)}}}),Object.assign(X.prototype,{clear:function(){this.a=null,this.b=null,Ammo.destroy(this.f)}}),Object.assign(Y.prototype,{step:function(){if(null!==this.ray){var t=this.rays.length,e=I.flow.ray.length;if(t){if(t===e)for(;e--;)this.rays[e].update(I.flow.ray[e]);I.flow.ray=[];var s=this.ray;this.rays.forEach(function(t,e){if(s.set_m_closestHitFraction(t.precision),s.set_m_collisionObject(null),s.get_m_rayFromWorld().fromArray(t.origin,0,I.invScale),s.get_m_rayToWorld().fromArray(t.dest,0,I.invScale),s.set_m_collisionFilterGroup(t.group),s.set_m_collisionFilterMask(t.mask),I.world.rayTest(s.get_m_rayFromWorld(),s.get_m_rayToWorld(),s),s.hasHit()){var i=Ammo.castObject(s.get_m_collisionObject(),Ammo.btRigidBody).name;void 0===i&&(i=Ammo.castObject(s.get_m_collisionObject(),Ammo.btSoftBody).name);var o=s.get_m_hitNormalWorld();o.normalize(),t.result.hit=!0,t.result.name=i,t.result.point=s.get_m_hitPointWorld().toArray(void 0,0,I.scale),t.result.normal=o.toArray()}else t.result.hit=!1,t.result.name="";I.flow.ray.push(t.result)})}}},update:function(t){var e=this.rays.length;if(e&&e===t.length)for(;e--;)this.rays[e].update(t[e])},clear:function(){for(;0<this.rays.length;)this.destroy(this.rays.pop());this.ID=0},destroy:function(t){t.clear(),q.delete(t.name)},remove:function(t){if(q.has(t)){var e=q.get(t),i=this.rays.indexOf(e);-1!=i&&(this.rays.splice(i,1),this.destroy(e))}},add:function(t){null===this.ray&&(this.ray=new Ammo.ClosestRayResultCallback);var e=void 0!==t.name?t.name:"ray"+this.ID++;this.remove(t.name);var i=new Z(e,t);this.rays.push(i),q.set(e,i)}}),Object.assign(Z.prototype,{update:function(t){this.precision=t.precision||1,this.origin=t.origin||[0,0,0],this.dest=t.dest||[0,1,0],this.group=void 0!==t.group?t.group:1,this.mask=void 0!==t.mask?t.mask:-1},clear:function(){}}),self.onmessage=function(t){var e=t.data;e.Ar&&i.engine.setAr(e.Ar),e.flow&&(I.flow=e.flow),i.engine[e.m](e.o)},i.engine=(A=null,w=!1,_="undefined"==typeof performance?Date:performance,x=3*(S=1/60),k=!1,V=T=O=!(z=2),F=[],D=null,j={now:R=C=0,delta:0,then:0,deltaTime:0,inter:0,tmp:0,n:0,timerate:0,last:0},i.engine={test:function(){},setAr:function(t){o=t},getAr:function(){return o},setDrive:function(){},setMove:function(){},setAngle:function(t){I.angle=t.angle},internStep:function(t){I.key=t.key,j.last=_.now(),A&&clearInterval(A),A=setInterval(function(){j.now=_.now(),i.engine.step({delta:.001*(j.now-j.last)}),j.last=j.now},1e3*S),console.log("is interne update")},step:function(t){w?(j.tmp<j.now-1e3&&(j.tmp=j.now,j.fps=j.n,j.n=0),j.n++):I.key=t.key,C=t.delta,this.stepRemove(),this.stepMatrix(),this.stepOptions(),this.stepForces(),f.step(),0!==R&&this.stepBreak(),k?I.world.stepSimulation(S,0):I.world.stepSimulation(C,z,S),h.step(o,s[0]),g.step(o,s[1]),v.step(o,s[2]),y.step(o,s[3]),p.step(o,s[4]),V&&d.step(o,s[5]),b.step(),I.flow.key=t.key,O?self.postMessage({m:"step",fps:j.fps,delta:j.delta,flow:I.flow,Ar:o},[o.buffer]):self.postMessage({m:"step",fps:j.fps,delta:C,flow:I.flow,Ar:o})},clearFlow:function(){I.flow={ray:[],terrain:[],vehicle:[]}},reset:function(t){R=0,this.clearFlow(),F=[],I.matrix=[],I.option=[],I.force=[],h.clear(),d.clear(),p.clear(),f.clear(),y.clear(),v.clear(),g.clear(),b.clear(),q.clear(),M.destroy(),t.full&&(this.clearWorld(),this.createWorld()),this.setGravity(),O||(o=new Float32Array(r)),self.postMessage({m:"start"})},addMulty:function(t){for(var e=0,i=t.length;e<i;e++)this.add(t[e]);t=[]},post:function(t,e){self.postMessage({m:t,o:e})},init:function(e){s=e.ArPos,r=e.ArMax,(O=e.isBuffer||!1)||(o=new Float32Array(r)),importScripts(e.blob),Ammo().then(function(t){Ammo.btTransform.prototype=Object.assign(Object.create(Ammo.btTransform.prototype),{identity:function(){return this.setIdentity(),this},positionFromArray:function(t,e,i){e=e||0;var o=M.vector3().fromArray(t,e,i);return this.setOrigin(o),o.free(),this},eulerFromArray:function(t,e){e=e||0;var i=M.quaternion().setFromEuler(t,e);return this.setRotation(i),i.free(),this},eulerFromArrayZYX:function(t,e){return e=e||0,this.getBasis().setEulerZYX(t[e],t[e+1],t[e+2]),this},getRow:function(t){return this.getBasis().getRow(t)},makeRotationDir:function(t){var e=M.vector3().fromArray(t),i=M.vector3(0,1,0),o=M.vector3().cross(i,e).normalize(),s=M.vector3().cross(e,o).normalize(),r=M.matrix3(),a=r.setV3(o,s,e).toQuaternion().normalize();this.setRotation(a),r.free(),a.free(),e.free(),i.free(),o.free(),s.free()},setFromDirection:function(t){var e=M.vector3().fromArray(t),i=M.vector3(),o=M.quaternion();if(.99999<e.y())o.set(0,0,0,1);else if(e.y()<-.99999)o.set(1,0,0,0);else{i.set(e.z(),0,-e.x());var s=Math.acos(e.y());o.setFromAxisAngle(i.toArray(),s)}return this.setRotation(o),e.free(),i.free(),o.free(),this},quartenionFromAxis:function(t){var e=M.quaternion().setFromAxis(t);return this.setRotation(e),e.free(),this},quartenionFromAxisAngle:function(t,e){var i=M.quaternion().setFromAxisAngle(t,e);return this.setRotation(i),i.free(),this},quaternionFromArray:function(t,e){e=e||0;var i=M.quaternion().fromArray(t,e);return this.setRotation(i),i.free(),this},fromArray:function(t,e,i){return this.positionFromArray(t,e=e||0,i),3<t.length&&this.quaternionFromArray(t,e+3),this},toArray:function(t,e,i){e=e||0,this.getOrigin().toArray(t,e,i),this.getRotation().toArray(t,e+3)},getInverse:function(){var t=M.transform();t.setIdentity();var e=this.getRotation().toMatrix3().transpose(),i=this.getOrigin().clone().negate(),o=e.multiplyByVector3(i),s=e.toQuaternion();return t.setOrigin(o),t.setRotation(s),i.free(),o.free(),s.free(),e.free(),t},multiply:function(t){var e=this.getRotation().toMatrix3(),i=t.getRotation().toMatrix3(),o=this.getOrigin().clone(),s=t.getOrigin().clone(),r=e.multiplyByVector3(s).add(o);this.setOrigin(r),e.multiply(i);var a=e.toQuaternion();return this.setRotation(a),e.free(),i.free(),o.free(),s.free(),a.free(),r.free(),this},clone:function(){var t=M.transform();return t.setIdentity(),t.setOrigin(this.getOrigin()),t.setRotation(this.getRotation()),t},copy:function(t){return this.setOrigin(t.getOrigin()),this.setRotation(t.getRotation()),this},free:function(){M.freeTransform(this)}}),Ammo.btVector3.prototype=Object.assign(Object.create(Ammo.btVector3.prototype),{set:function(t,e,i){return this.setValue(t,e,i),this},zero:function(){return this.setValue(0,0,0),this},negate:function(){return this.setValue(-this.x(),-this.y(),-this.z()),this},add:function(t){return this.setValue(this.x()+t.x(),this.y()+t.y(),this.z()+t.z()),this},sub:function(t){return this.setValue(this.x()-t.x(),this.y()-t.y(),this.z()-t.z()),this},dot:function(t){return this.x()*t.x()+this.y()*t.y()+this.z()*t.z()},cross:function(t,e){var i=t.x(),o=t.y(),s=t.z(),r=e.x(),a=e.y(),n=e.z();return this.set(o*n-s*a,s*r-i*n,i*a-o*r),this},multiplyScalar:function(t){return this.setValue(this.x()*t,this.y()*t,this.z()*t),this},multiplyArray:function(t){return this.setValue(this.x()*t[0],this.y()*t[1],this.z()*t[2]),this},fromArray:function(t,e,i){return this.setValue(t[e=e||0]*(i=i||1),t[e+1]*i,t[e+2]*i),this},divideScalar:function(t){return this.multiplyScalar(1/t)},length:function(){return Math.sqrt(this.x()*this.x()+this.y()*this.y()+this.z()*this.z())},normalize:function(){return this.divideScalar(this.length()||1)},toArray:function(t,e,i){return void 0===t&&(t=[]),void 0===e&&(e=0),i=i||1,t[e]=this.x()*i,t[e+1]=this.y()*i,t[e+2]=this.z()*i,t},direction:function(t){var e=t.x(),i=t.y(),o=t.z(),s=t.w(),r=this.x(),a=this.y(),n=this.z(),l=s*r+i*n-o*a,c=s*a+o*r-e*n,m=s*n+e*a-i*r,h=-e*r-i*a-o*n;return this.setValue(l*s+h*-e+c*-o-m*-i,c*s+h*-i+m*-e-l*-o,m*s+h*-o+l*-i-c*-e),this},clone:function(){return M.vector3().set(this.x(),this.y(),this.z())},free:function(){M.freeVector3(this)}}),Ammo.btQuaternion.prototype=Object.assign(Object.create(Ammo.btQuaternion.prototype),{set:function(t,e,i,o){return this.setValue(t,e,i,o),this},fromArray:function(t,e){return void 0===e&&(e=0),this.setValue(t[e],t[e+1],t[e+2],t[e+3]),this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x(),t[e+1]=this.y(),t[e+2]=this.z(),t[e+3]=this.w(),t},setFromAxis:function(t){return.99999<t[2]?this.setValue(0,0,0,1):t[2]<-.99999?this.setValue(1,0,0,0):this.setFromAxisAngle([t[1],t[0],0],Math.acos(t[2])),this},setFromAxisAngle:function(t,e){var i=.5*e,o=Math.sin(i);return this.setValue(t[0]*o,t[1]*o,t[2]*o,Math.cos(i)),this},setFromEuler:function(t){var e,i,o,s,r=t[0],a=t[1],n=t[2],l=t[3]||"XYZ",c=Math.cos,m=Math.sin,h=c(.5*r),p=c(.5*a),d=c(.5*n),f=m(.5*r),u=m(.5*a),y=m(.5*n);return"XYZ"===l?(e=f*p*d+h*u*y,i=h*u*d-f*p*y,o=h*p*y+f*u*d,s=h*p*d-f*u*y):"YXZ"===l?(e=f*p*d+h*u*y,i=h*u*d-f*p*y,o=h*p*y-f*u*d,s=h*p*d+f*u*y):"ZXY"===l?(e=f*p*d-h*u*y,i=h*u*d+f*p*y,o=h*p*y+f*u*d,s=h*p*d-f*u*y):"ZYX"===l?(e=f*p*d-h*u*y,i=h*u*d+f*p*y,o=h*p*y-f*u*d,s=h*p*d+f*u*y):"YZX"===l?(e=f*p*d+h*u*y,i=h*u*d+f*p*y,o=h*p*y-f*u*d,s=h*p*d-f*u*y):"XZY"===l&&(e=f*p*d-h*u*y,i=h*u*d-f*p*y,o=h*p*y+f*u*d,s=h*p*d+f*u*y),this.setValue(e,i,o,s),this},toMatrix3:function(){var t=[],e=this.x(),i=this.y(),o=this.z(),s=this.w(),r=e*e,a=i*i,n=o*o,l=e*i,c=i*o,m=o*e,h=e*s,p=i*s,d=o*s;return t[0]=1-2*(a+n),t[1]=2*(l-d),t[2]=2*(m+p),t[3]=2*(l+d),t[4]=1-2*(n+r),t[5]=2*(c-h),t[6]=2*(m-p),t[7]=2*(c+h),t[8]=1-2*(r+a),M.matrix3().fromArray(t)},length:function(){return Math.sqrt(this.x()*this.x()+this.y()*this.y()+this.z()*this.z()+this.w()*this.w())},normalize:function(){var t=this.length();return 0===t?this.set(0,0,0,1):(t=1/t,this.set(this.x()*t,this.y()*t,this.z()*t,this.w()*t))},multiply:function(t){return this.multiplyQuaternions(this,t)},multiplyQuaternions:function(t,e){var i=t.x(),o=t.y(),s=t.z(),r=t.w(),a=e.x(),n=e.y(),l=e.z(),c=e.w();return this.set(i*c+r*a+o*l-s*n,o*c+r*n+s*a-i*l,s*c+r*l+i*n-o*a,r*c-i*a-o*n-s*l),this},clone:function(){return M.quaternion().set(this.x(),this.y(),this.z(),this.w())},free:function(){M.freeQuaternion(this)}}),i.engine.createWorld(e.option),i.engine.set(e.option),h=new W,d=new B,p=new L,f=new P,y=new E,v=new Q,g=new J,b=new Y,new t.ClosestRayResultCallback,c=M.transform(),m=M.vector3(),I.makeShape=function(t){return h.add(t,"isShape")},self.postMessage({m:"initEngine"})})},remove:function(t){if(q.has(t))switch(q.get(t).type){case"solid":case"body":h.remove(t);break;case"soft":p.remove(t);break;case"terrain":f.remove(t);break;case"joint":case"constraint":d.remove(t);break;case"collision":g.remove(t);break;case"ray":b.remove(t)}},setRemove:function(t){F=F.concat(t)},stepRemove:function(){for(;0<F.length;)this.remove(F.pop())},directRemoves:function(t){this.setRemove(t),this.stepRemove()},add:function(t){t.type=void 0===t.type?"box":t.type,void 0!==t.breakable&&t.breakable&&R++;var e=t.type,i=t.type.substring(0,4);"join"==i?d.add(t):"soft"==i||"ellipsoid"===e?p.add(t):"terrain"===e?f.add(t):"character"===e?v.add(t):"collision"===e?g.add(t):"ray"===e?b.add(t):"car"===e?y.add(t):h.add(t)},addAnchor:function(t){p.addAnchor(t)},setVehicle:function(t){y.setData(t)},createWorld:function(t){if(null===I.world){switch(t=t||{},(D=new Ammo.btVector3).set(0,0,0),T=void 0===t.soft||t.soft,e=new Ammo.btSequentialImpulseConstraintSolver,a=T?new Ammo.btDefaultSoftBodySolver:null,n=T?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration,u=new Ammo.btCollisionDispatcher(n),void 0===t.broadphase?2:t.broadphase){case 1:l=new Ammo.btAxisSweep3(new Ammo.btVector3(-1e3,-1e3,-1e3),new Ammo.btVector3(1e3,1e3,1e3),4096);break;case 2:l=new Ammo.btDbvtBroadphase}I.world=T?new Ammo.btSoftRigidDynamicsWorld(u,l,e,n,a):new Ammo.btDiscreteDynamicsWorld(u,l,e,n),I.post=this.post}else console.error("World already existe !!")},clearWorld:function(){Ammo.destroy(I.world),Ammo.destroy(e),null!==a&&Ammo.destroy(a),Ammo.destroy(n),Ammo.destroy(u),Ammo.destroy(l),I.world=null},setWorldscale:function(t){I.scale=t,I.invScale=1/t},setGravity:function(t){t=t||{},I.gravity=new Ammo.btVector3,I.gravity.fromArray(void 0!==t.gravity?t.gravity:[0,-9.81,0]),I.world.setGravity(I.gravity),T&&I.world.getWorldInfo().set_m_gravity(I.gravity)},set:function(t){this.setWorldscale(void 0!==(t=t||{}).worldscale?t.worldscale:1),S=void 0!==t.fps?1/t.fps:1/60,z=void 0!==t.substep?t.substep:2,k=void 0!==t.fixed&&t.fixed,j.inter=void 0!==t.fps?1e3/t.fps:1e3/60,w=t.isInternUpdate||!1,I.constraintDebug=V=void 0!==t.jointDebug&&t.jointDebug,x=3*S,void 0!==t.penetration&&I.world.getDispatchInfo().set_m_allowedCcdPenetration(t.penetration),this.setGravity(t)},setForces:function(t){I.force=I.force.concat(t)},directForces:function(t){this.setForces(t),this.stepForces()},stepForces:function(){for(var t=I.force.length;t--;)this.applyForces(I.force[t]);I.force=[]},applyForces:function(t){var e=t.name;if(q.has(e)){var i=q.get(e),o=M.vector3(),s=M.vector3(),r=M.quaternion();switch(void 0!==t.direction&&o.fromArray(M.vectomult(t.direction,I.invScale)),void 0!==t.distance?s.fromArray(M.vectomult(t.distance,I.invScale)):s.zero(),t.type){case"force":case 0:i.applyForce(o,s);break;case"torque":case 1:i.applyTorque(o);break;case"localTorque":case 2:i.applyLocalTorque(o);break;case"forceCentral":case 3:i.applyCentralForce(o);break;case"forceLocal":case 4:i.applyCentralLocalForce(o);break;case"impulse":case 5:i.applyImpulse(o,s);break;case"impulseCentral":case 6:i.applyCentralImpulse(o);break;case"motor":case 7:i.enableAngularMotor(t.enable||!0,t.targetVelocity,t.maxMotor);break;case"motorTarget":case 8:i.setMotorTarget(t.target,t.axis||-1);case"setLimit":case 9:i.setLimit(t.limit[0]*M.torad,t.limit[1]*M.torad,t.limit[2]||.9,t.limit[3]||.3,t.limit[4]||1)}o.free(),s.free(),r.free()}},setMatrix:function(t){I.matrix=I.matrix.concat(t)},directMatrix:function(t){this.setMatrix(t),this.stepMatrix()},stepMatrix:function(){for(var t=I.matrix.length;t--;)this.applyMatrix(I.matrix[t]);I.matrix=[]},applyMatrix:function(t){var e=t.name;if(q.has(e)){var i=q.get(e);if(i.isCharacter)i.setMatrix(t);else{var o=c.identity(),s=m;if(void 0===t.rot&&void 0===t.quat&&(t.quat=[0,0,0,1]),t.keepX||t.keepY||t.keepZ||t.keepRot){i.getMotionState().getWorldTransform(o);var r=[];o.toArray(r),void 0!==t.keepX&&(t.pos[0]=r[0]-t.pos[0]),void 0!==t.keepY&&(t.pos[1]=r[1]-t.pos[1]),void 0!==t.keepZ&&(t.pos[2]=r[2]-t.pos[2]),void 0!==t.keepRot&&(t.quat=[r[3],r[4],r[5],r[6]])}if(void 0!==t.pos&&(void 0!==t.rot&&(t.quat=M.eulerToQuadArray(t.rot,!0)),t.pos=t.pos.concat(t.quat),o.fromArray(t.pos,0,I.invScale),i.isKinematic?i.getMotionState().setWorldTransform(o):i.setWorldTransform(o)),void 0!==t.clamped){var a=x<C?1:C/x;s.fromArray(t.pos,0,I.invScale).sub(i.getWorldTransform().getOrigin()).multiplyScalar(a),i.setLinearVelocity(s)}t.velocity&&!i.isGhost&&(t.velocity[0]&&i.setLinearVelocity(s.fromArray(t.velocity[0],0,I.invScale)),t.velocity[1]&&i.setAngularVelocity(s.fromArray(t.velocity[1]))),t.noVelocity&&!i.isGhost&&(i.setLinearVelocity(D),i.setAngularVelocity(D)),t.noGravity&&i.setGravity(D),t.activate&&i.activate(),"body"!==i.type||i.isKinematic||i.activate(),"solid"===i.type&&self.postMessage({m:"moveSolid",o:{name:e,pos:t.pos,quat:t.quat}})}}},setOptions:function(t){I.option=I.option.concat(t)},directOptions:function(t){this.setOptions(t),this.stepOptions()},stepOptions:function(){for(var t=I.option.length;t--;)this.applyOption(I.option[t]);I.option=[]},applyOption:function(t){var e=t.name;if("join"==(void 0===t.type?"box":t.type).substring(0,4)){var i=q.get(e);d.applyOption(i,t)}else{if(!q.has(e))return;var o=q.get(e);switch(o.type){case"solid":case"body":h.applyOption(o,t);break;case"soft":p.applyOption(o,t);break;case"character":o.applyOption(t)}}},stepBreak:function(){for(var t,e,i,o,s,r,a,n,l,c,m,h=0,p=u.getNumManifolds();h<p;h++)if(t=u.getManifoldByIndexInternal(h),c=Ammo.castObject(t.getBody0(),Ammo.btRigidBody),m=Ammo.castObject(t.getBody1(),Ammo.btRigidBody),n=c.name,l=m.name,c.breakable||m.breakable){i=!1;for(var d=o=0,f=t.getNumContacts();d<f;d++)if((e=t.getContactPoint(d)).getDistance()<0){i=!0,o<(s=e.getAppliedImpulse())&&(o=s,r=e.get_m_positionWorldOnB().toArray(),a=e.get_m_normalWorldOnB().toArray());break}i&&(c.breakable&&c.breakOption[0]<o&&self.postMessage({m:"makeBreak",o:{name:n,pos:M.vectomult(r,I.scale),normal:a,breakOption:c.breakOption}}),m.breakable&&m.breakOption[0]<o&&self.postMessage({m:"makeBreak",o:{name:l,pos:M.vectomult(r,I.scale),normal:a,breakOption:m.breakOption}}))}}},i.engine),Object.defineProperty(i,"__esModule",{value:!0})});
