!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ammowker={})}(this,function(i){"use strict";var k={T:[],Q:[],V3:[],M3:[],torad:Math.PI/180,todeg:180/Math.PI,clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},eulerToQuadArray:function(t,e){e&&(t=k.vectomult(t,k.torad));e=k.quaternion().setFromEuler(t),t=e.toArray();return e.free(),t},getLength:function(){return"T:"+k.T.length+" Q:"+k.Q.length+" V:"+k.V3.length},destroy:function(){for(;0<k.T.length;)Ammo.destroy(k.T.pop());for(;0<k.Q.length;)Ammo.destroy(k.Q.pop());for(;0<k.V3.length;)Ammo.destroy(k.V3.pop());k.M3=[]},transform:function(){return 0<k.T.length?k.T.pop():new Ammo.btTransform},freeTransform:function(t){k.T.push(t)},quaternion:function(){return 0<k.Q.length?k.Q.pop():new Ammo.btQuaternion},freeQuaternion:function(t){k.Q.push(t)},vector3:function(){return 0<k.V3.length?k.V3.pop():new Ammo.btVector3},freeVector3:function(t){k.V3.push(t)},matrix3:function(){return 0<k.M3.length?k.M3.pop():new t},freeMatrix3:function(t){k.M3.push(t)},vectomult:function(t,e){return t=t.map(function(t){return t*e})},distanceArray:function(t,e){var i=e[0]-t[0],o=e[1]-t[1],t=e[2]-t[2];return Math.sqrt(i*i+o*o+t*t)}};function t(){this.elements=[1,0,0,0,1,0,0,0,1]}Object.assign(t.prototype,{set:function(t,e,i,o,s,r,n,a,l){var c=this.elements;return c[0]=t,c[1]=o,c[2]=n,c[3]=e,c[4]=s,c[5]=a,c[6]=i,c[7]=r,c[8]=l,this},setV3:function(t,e,i){var o=this.elements;return o[0]=t.x(),o[3]=t.y(),o[6]=t.z(),o[1]=e.x(),o[4]=e.y(),o[7]=e.z(),o[2]=i.x(),o[5]=i.y(),o[8]=i.z(),this},transpose:function(){var t=this.elements,e=t[1];return t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},fromArray:function(t,e){void 0===e&&(e=0);for(var i=0;i<9;i++)this.elements[i]=t[i+e];return this},multiply:function(t){var e=this.row(0),i=this.row(1),o=this.row(2),s=t.column(0),r=t.column(1),n=t.column(2),t=this.elements;return t[0]=e.dot(s),t[1]=e.dot(r),t[2]=e.dot(n),t[3]=i.dot(s),t[4]=i.dot(r),t[5]=i.dot(n),t[6]=o.dot(s),t[7]=o.dot(r),t[8]=o.dot(n),e.free(),i.free(),o.free(),s.free(),r.free(),n.free(),this},multiplyByVector3:function(t){var e=this.row(0),i=this.row(1),o=this.row(2),t=k.vector3().set(e.dot(t),i.dot(t),o.dot(t));return e.free(),i.free(),o.free(),t},toQuaternion:function(){var t,e,i,o=this.elements,s=o[0]+o[4]+o[8],r=0<s?(i=.25*(r=2*Math.sqrt(s+1)),t=(o[7]-o[5])/r,e=(o[2]-o[6])/r,(o[3]-o[1])/r):o[4]<o[0]&&o[8]<o[0]?(i=(o[7]-o[5])/(r=2*Math.sqrt(1+o[0]-o[4]-o[8])),t=.25*r,e=(o[1]+o[3])/r,(o[2]+o[6])/r):o[8]<o[4]?(i=(o[2]-o[6])/(r=2*Math.sqrt(1+o[4]-o[0]-o[8])),t=(o[1]+o[3])/r,e=.25*r,(o[5]+o[7])/r):(i=(o[3]-o[1])/(r=2*Math.sqrt(1+o[8]-o[0]-o[4])),t=(o[2]+o[6])/r,e=(o[5]+o[7])/r,.25*r);return k.quaternion().set(t,e,r,i)},row:function(t){var e=this.elements,t=3*t;return k.vector3().set(e[t],e[1+t],e[2+t])},column:function(t){var e=this.elements;return k.vector3().set(e[t],e[t+3],e[t+6])},free:function(){k.freeMatrix3(this)}});var o,s,r,e,n,a,u,l,c,m,h,p,d,f,y,g,v,b,A,w,_,S,x,z,M,C,O,T,V,F,D,R,j,I={Ar:null,ArPos:null,constraintDebug:!1,matrix:[],force:[],option:[],flow:{ray:[],terrain:[],vehicle:[]},world:null,gravity:null,scale:1,invscale:1,angle:0,key:[0,0,0,0,0,0,0,0],post:null,makeShape:null},q=new Map;function W(){this.ID=0,this.solids=[],this.bodys=[],this.trans=new Ammo.btTransform,this.zero=new Ammo.btVector3,this.zero.set(0,0,0)}function B(){this.ID=0,this.joints=[],this.t1=new Ammo.btTransform,this.t2=new Ammo.btTransform}function L(){this.ID=0,this.softs=[]}function P(){this.ID=0,this.terrains=[]}function H(t,e){var i=k.transform(),o=k.vector3();this.needsUpdate=!1,this.data=null,this.tmpData=null,this.dataHeap=null,this.type="terrain",1!==I.scale&&(e.pos=k.vectomult(e.pos,I.invScale),e.size=k.vectomult(e.size,I.invScale));var s=void 0===e.size?[1,1,1]:e.size,r=void 0===e.sample?[64,64]:e.sample,n=void 0===e.pos?[0,0,0]:e.pos,a=void 0===e.quat?[0,0,0,1]:e.quat,l=void 0===e.mass?0:e.mass,c=void 0===e.margin?.02:e.margin,m=void 0===e.friction?.5:e.friction,h=void 0===e.restitution?0:e.restitution,p=void 0===e.flag?1:e.flag,d=void 0===e.heightScale?1:e.heightScale,f=void 0===e.upAxis?1:e.upAxis,u=e.hdt||"PHY_FLOAT",y=void 0!==e.flipEdge&&e.flipEdge;this.setData(e.heightData),this.update();y=new Ammo.btHeightfieldTerrainShape(r[0],r[1],this.data,d,-s[1],s[1],f,u,y);o.set(s[0]/r[0],1,s[2]/r[1]),y.setLocalScaling(o),y.setMargin(c),i.identity().fromArray(n.concat(a)),o.set(0,0,0);a=new Ammo.btDefaultMotionState(i),y=new Ammo.btRigidBodyConstructionInfo(l,a,y,o);y.set_m_friction(m),y.set_m_restitution(h);h=new Ammo.btRigidBody(y);h.setCollisionFlags(p),this.name=h.name=t,this.body=h,Ammo.destroy(y),i.free(),o.free()}function G(){this.ID=0,this.cars=[],this.trans=new Ammo.btTransform}function E(t,e,i){this.name=t,this.chassis=null,this.body=null,this.steering=0,this.breaking=0,this.motor=0,this.gearRatio=[-1,0,2.3,1.8,1.3,.9,.5],this.limitAngular=[1,1,1],this.transforms=[],this.wheelBody=[],this.wheelJoint=[],this.wheelRadius=[],this.isRay=!0,this.data={mass:100,wMass:1,wWidth:.25,nWheel:e.nWheel||4,wPos:[1,0,1.6],engine:1e3,acceleration:10,maxSteering:24*k.torad,breaking:100,incSteering:.04,pos:[0,0,0],quat:[0,0,0,1],massCenter:[0,-.6,0],friction:.6,restitution:.1,linear:0,angular:0,rolling:0,autoSuspension:!1,compValue:.2,dampValue:.3,s_stiffness:20,s_compression:2.3,s_damping:4.4,s_travel:5,s_force:6e3,s_length:.2,w_friction:10.5,w_roll:.001},this.init(e,i)}function Q(){this.ID=0,this.heroes=[]}function U(t,e){this.type="character",this.name=t,this.body=null,this.controller=null,this.angle=0,this.speed=0,this.wasJumping=!1,this.verticalVelocity=0,this.angleInc=.1,this.q=new Ammo.btQuaternion,this.position=new Ammo.btVector3,this.init(e)}function J(){this.ID=0,this.pairs=[]}function X(t,e,i){this.name=i,this.result=0,this.type="collision",this.pa=[0,0,0],this.pb=[0,0,0],this.nb=[0,0,0],this.distance=0,this.impulse=0,this.maxImpulse=0,this.a=t,this.b=e,this.f=new Ammo.ConcreteContactResultCallback,this.f.addSingleResult=function(){this.result=1}.bind(this)}function Y(){this.ID=0,this.rays=[],this.ray=null,this.results=[]}function Z(t,e){this.name=t,this.type="ray",this.precision=1,this.update(e),this.result={hit:!1,name:"",point:[0,0,0],normal:[0,0,0]}}Object.assign(W.prototype,{step:function(i,o){var s,r=this.trans,n=I.scale;this.bodys.forEach(function(t,e){i[s=o+8*e]=9.8*t.getLinearVelocity().length(),t.getMotionState().getWorldTransform(r),r.toArray(i,s+1,n)})},clear:function(){for(;0<this.bodys.length;)this.destroy(this.bodys.pop());for(;0<this.solids.length;)this.destroy(this.solids.pop());this.ID=0},destroy:function(t){"solid"===t.type?I.world.removeCollisionObject(t):I.world.removeRigidBody(t),Ammo.destroy(t),q.delete(t.name)},remove:function(t){var e,i;!q.has(t)||-1!=(t=((i="solid"===(e=q.get(t)).type)?this.solids:this.bodys).indexOf(e))&&((i?this.solids:this.bodys).splice(t,1),this.destroy(e))},add:function(t,e){var i=void 0!==t.name?t.name:"body"+this.ID++;this.remove(i),void 0!==t.density&&(t.mass=t.density),void 0!==t.bounce&&(t.restitution=t.bounce);var o=void 0===t.mass?0:t.mass,s=t.kinematic||!1,r=t.ghost||!1;r&&(o=0);var n=k.vector3(),a=k.vector3(),l=k.vector3(),c=k.vector3(),m=k.vector3(),h=k.transform(),p=void 0!==t.noMesh&&t.noMesh;s&&(t.flag=2,t.state=4,void 0===t.group&&(t.group=4)),t.size=void 0===t.size?[1,1,1]:t.size,t.pos=void 0===t.pos?[0,0,0]:t.pos,t.quat=void 0===t.quat?[0,0,0,1]:t.quat,1!==I.scale&&(t.pos=k.vectomult(t.pos,I.invScale),t.size=k.vectomult(t.size,I.invScale),void 0!==t.masscenter&&(t.masscenter=k.vectomult(t.masscenter,I.invScale)));var d,f,u=null;switch("hardbox"!==t.type&&"realhardbox"!==t.type&&"ChamferBox"!==t.type||(t.type="box"),"realcylinder"!==t.type&&"ChamferCyl"!==t.type||(t.type="cylinder"),"realcone"===t.type&&(t.type="cone"),"realsphere"===t.type&&(t.type="sphere"),t.type){case"plane":m.fromArray(t.dir||[0,1,0]),u=new Ammo.btStaticPlaneShape(m,0);break;case"box":m.setValue(.5*t.size[0],.5*t.size[1],.5*t.size[2]),u=new Ammo.btBoxShape(m);break;case"sphere":u=new Ammo.btSphereShape(t.size[0]);break;case"cylinder":m.setValue(t.size[0],.5*t.size[1],.5*t.size[2]),u=new Ammo.btCylinderShape(m);break;case"cone":u=new Ammo.btConeShape(t.size[0],.5*t.size[1]);break;case"capsule":u=new Ammo.btCapsuleShape(t.size[0],t.size[1]);break;case"compound":for(var y,u=new Ammo.btCompoundShape,g=k.transform(),v=0;v<t.shapes.length;v++){switch((y=t.shapes[v]).quat=void 0===y.quat?[0,0,0,1]:y.quat,1!==I.scale&&(y.pos=k.vectomult(y.pos,I.invScale),y.size=k.vectomult(y.size,I.invScale)),g.identity().fromArray(y.pos.concat(y.quat)),y.type){case"box":m.setValue(.5*y.size[0],.5*y.size[1],.5*y.size[2]),b=new Ammo.btBoxShape(m);break;case"sphere":b=new Ammo.btSphereShape(y.size[0]);break;case"cylinder":m.setValue(y.size[0],.5*y.size[1],.5*y.size[2]),b=new Ammo.btCylinderShape(m);break;case"cone":b=new Ammo.btConeShape(y.size[0],.5*y.size[1]);break;case"capsule":b=new Ammo.btCapsuleShape(y.size[0],y.size[1]);break;case"convex":for(var b=new Ammo.btConvexHullShape,v=0,A=(_=y.v).length;v<A;v+=3)_[v]*=y.size[0],_[v+1]*=y.size[1],_[v+2]*=y.size[2],m.fromArray(_,v),b.addPoint(m)}u.addChildShape(g,b)}g.free();break;case"mesh":for(var w=new Ammo.btTriangleMesh,v=0,A=(_=t.v).length;v<A;v+=9)a.set(_[v+0]*t.size[0],_[v+1]*t.size[1],_[v+2]*t.size[2]),l.set(_[v+3]*t.size[0],_[v+4]*t.size[1],_[v+5]*t.size[2]),c.set(_[v+6]*t.size[0],_[v+7]*t.size[1],_[v+8]*t.size[2]),w.addTriangle(a,l,c,!0);u=0===o?new Ammo.btBvhTriangleMeshShape(w,!0,!0):new Ammo.btConvexTriangleMeshShape(w,!0);break;case"convex":u=new Ammo.btConvexHullShape;for(var _,v=0,A=(_=t.v).length;v<A;v+=3)_[v]*=t.size[0],_[v+1]*=t.size[1],_[v+2]*=t.size[2],m.fromArray(_,v),u.addPoint(m);t.optimized&&(u.recalcLocalAabb(),u.initializePolyhedralFeatures())}if(void 0!==u.setMargin&&"sphere"!==t.type&&"capsule"!==t.type&&"compound"!==t.type&&(void 0!==t.margin?u.setMargin(t.margin*I.invScale):void 0!==u.getMargin&&1!==I.scale&&u.setMargin(u.getMargin()*I.invScale)),"isShape"==e)return u;if(h.identity().fromArray(t.pos.concat(t.quat)),t.bonePos&&(d=k.vector3().fromArray(t.bonePos).multiplyScalar(I.invScale),(f=k.transform()).identity(),f.setOrigin(d),h.multiply(f),f.free()),"isGhost"==e){var S=new Ammo.btGhostObject;return S.setCollisionShape(u),S.setCollisionFlags(t.flag||4),S.setWorldTransform(h),S}a.setValue(0,0,0),0!==o&&u.calculateLocalInertia(o,a);var x,e=new Ammo.btDefaultMotionState(h),S=new Ammo.btRigidBodyConstructionInfo(o,e,u,a);void 0!==t.friction&&S.set_m_friction(t.friction),void 0!==t.restitution&&S.set_m_restitution(t.restitution),void 0!==t.linear&&S.set_m_linearDamping(t.linear),void 0!==t.angular&&S.set_m_angularDamping(t.angular),void 0!==t.rolling&&S.set_m_rollingFriction(t.rolling),t.masscenter?(n.fromArray(t.masscenter).negate(),h.setIdentity(),h.setOrigin(n),(x=new Ammo.btCompoundShape).addChildShape(h,u),h.identity().fromArray(t.pos.concat(t.quat)),n.setValue(0,0,0),x.calculateLocalInertia(o,n),e=new Ammo.btDefaultMotionState(h),S=new Ammo.btRigidBodyConstructionInfo(o,e,x,n)):r?((x=new Ammo.btGhostObject).setCollisionShape(u),x.setWorldTransform(h),t.flag=t.flag||4,x.setCollisionFlags(t.flag),x.isGhost=!0):(x=new Ammo.btRigidBody(S),s&&(x.isKinematic=!0)),x.name=i,0!==o||s?(x.setCollisionFlags(t.flag||0),x.setActivationState(t.state||1),t.neverSleep&&x.setSleepingThresholds(0,0),I.world.addRigidBody(x,t.group||1,t.mask||-1),p?(x.type="body",this.solids.push(x)):(x.type="body",this.bodys.push(x))):(x.setCollisionFlags(t.flag||1),I.world.addCollisionObject(x,t.group||2,t.mask||-1),x.type="solid",this.solids.push(x)),x.breakable=void 0!==t.breakable&&t.breakable,x.breakable&&(x.breakOption=void 0!==t.breakOption?t.breakOption:[250,1,2,1]),q.set(i,x),Ammo.destroy(S),this.applyOption(x,t),h.free(),n.free(),a.free(),l.free(),c.free(),m.free()},applyOption:function(t,e){var i,o,s=k.vector3();void 0!==e.flag&&(t.setCollisionFlags(e.flag),t.isKinematic=2===e.flag),void 0!==e.state&&t.setActivationState(e.state),void 0!==e.activate&&t.activate(),t.isGhost||(void 0!==e.group&&t.getBroadphaseProxy().set_m_collisionFilterGroup(e.group),void 0!==e.mask&&t.getBroadphaseProxy().set_m_collisionFilterMask(e.mask),void 0!==e.damping&&t.setDamping(e.damping[0],e.damping[1]),void 0!==e.sleeping&&t.setSleepingThresholds(e.sleeping[0],e.sleeping[1])),void 0!==e.friction&&t.setFriction(e.friction),void 0!==e.restitution&&t.setRestitution(e.restitution),void 0!==e.rollingFriction&&t.setRollingFriction(e.rollingFriction),void 0!==e.linearVelocity&&t.setLinearVelocity(s.fromArray(e.linearVelocity,0,I.invScale)),void 0!==e.angularVelocity&&t.setAngularVelocity(s.fromArray(e.angularVelocity)),void 0!==e.linearFactor&&t.setLinearFactor(s.fromArray(e.linearFactor)),void 0!==e.angularFactor&&t.setAngularFactor(s.fromArray(e.angularFactor)),void 0!==e.anisotropic&&t.setAnisotropicFriction(e.anisotropic[0],e.anisotropic[1]),void 0!==e.massProps&&t.setMassProps(e.massProps[0],e.massProps[1]),void 0!==e.gravity&&t.setGravity(e.gravity?I.gravity:this.zero),void 0!==e.ccdThreshold&&t.setCcdMotionThreshold(e.ccdThreshold),void 0!==e.ccdRadius&&t.setCcdSweptSphereRadius(e.ccdRadius),e.trans&&((i=k.transform()).identity().fromArray(e.trans),e.mmdPos&&((o=k.transform()).identity().fromArray(e.mmdPos.concat(e.mmdQuat)),i.multiply(o),o.free()),t.setCenterOfMassTransform(i),t.getMotionState().setWorldTransform(i),i.free()),s.free()}}),Object.assign(B.prototype,{step:function(i,o){var s,r=this.t1,n=this.t2,a=I.scale;this.joints.forEach(function(t,e){s=o+14*e,r.copy(q.get(t.b1).getWorldTransform()).multiply(t.formA).toArray(i,s,a),n.copy(q.get(t.b2).getWorldTransform()).multiply(t.formB).toArray(i,s+7,a)})},clear:function(){for(;0<this.joints.length;)this.destroy(this.joints.pop());this.ID=0},destroy:function(t){I.world.removeConstraint(t),t.formA.free(),t.formB.free(),Ammo.destroy(t),q.delete(t.name)},remove:function(t){var e;q.has(t)&&(e=q.get(t),-1!=(t=this.joints.indexOf(e))&&(this.joints.splice(t,1),this.destroy(e)))},add:function(t){t.name=void 0!==t.name?t.name:"joint"+this.ID++;var e=t.name;if(this.remove(e),t.body1&&(t.b1=t.body1),t.body2&&(t.b2=t.body2),q.has(t.b1)&&q.has(t.b2)){var i=q.get(t.b1),o=q.get(t.b2);i.activate(),o.activate();var s,r=k.vector3(),n=k.vector3().fromArray(t.pos1||[0,0,0]).multiplyScalar(I.invScale),a=k.vector3().fromArray(t.pos2||[0,0,0]).multiplyScalar(I.invScale),l=k.vector3().fromArray(t.axe1||[1,0,0]),c=k.vector3().fromArray(t.axe2||[1,0,0]),m=k.transform().identity(),h=k.transform().identity();"joint_p2p"!==t.type&&"joint_hinge"!==t.type&&"joint"!==t.type&&(void 0===t.local||t.local?(m.setOrigin(n),void 0!==t.quat1?m.quaternionFromArray(t.quat1):t.axe1&&m.quartenionFromAxis(t.axe1),h.setOrigin(a),void 0!==t.quat2?h.quaternionFromArray(t.quat2):t.axe2&&h.quartenionFromAxis(t.axe2)):((s=k.transform()).identity().fromArray(t.pos1.concat(t.quat1)),i.getMotionState().getWorldTransform(m),m=m.getInverse().multiply(s),s.identity().fromArray(t.pos2.concat(t.quat2)),o.getMotionState().getWorldTransform(h),h=h.getInverse().multiply(s),s.free()));var p,d,f=void 0===t.useA||t.useA;switch(t.type){case"joint_p2p":d=1,p=new Ammo.btPoint2PointConstraint(i,o,n,a),t.strength&&p.get_m_setting().set_m_tau(t.strength),t.damping&&p.get_m_setting().set_m_damping(t.damping),t.impulse&&p.get_m_setting().set_m_impulseClamp(t.impulse);break;case"joint_hinge":case"joint":d=2,p=new Ammo.btHingeConstraint(i,o,n,a,l,c,f);break;case"joint_hinge_ref":d=2,p=new Ammo.btHingeConstraint(i,o,m,h,f);break;case"joint_slider":d=3,p=new Ammo.btSliderConstraint(i,o,m,h,f);break;case"joint_conetwist":d=4,p=new Ammo.btConeTwistConstraint(i,o,m,h);break;case"joint_dof":d=5,p=new Ammo.btGeneric6DofConstraint(i,o,m,h,f);break;case"joint_spring_dof":d=6,p=new Ammo.btGeneric6DofSpringConstraint(i,o,m,h,f);break;case"joint_fixe":d=7,p=new Ammo.btFixedConstraint(i,o,m,h)}if(p.b1=t.b1,p.b2=t.b2,p.formA=m.clone(),p.formB=h.clone(),t.breaking&&p.setBreakingImpulseThreshold&&p.setBreakingImpulseThreshold(t.breaking),t.limit&&p.setLimit&&("joint_hinge"!==t.type&&"joint"!==t.type&&"joint_hinge_ref"!==t.type||p.setLimit(t.limit[0]*k.torad,t.limit[1]*k.torad,void 0!==t.limit[2]?t.limit[2]:.9,void 0!==t.limit[3]?t.limit[3]:.3,void 0!==t.limit[4]?t.limit[4]:1),"joint_conetwist"===t.type&&(p.setLimit(3,t.limit[2]*k.torad),p.setLimit(4,t.limit[1]*k.torad),p.setLimit(5,t.limit[0]*k.torad))),t.limit&&"joint_slider"===t.type&&(t.limit[0]&&p.setLowerLinLimit(t.limit[0]*I.invScale),t.limit[1]&&p.setUpperLinLimit(t.limit[1]*I.invScale),t.limit[2]&&p.setLowerAngLimit(t.limit[2]*k.torad),t.limit[3]&&p.setUpperAngLimit(t.limit[3]*k.torad)),p.setLinearLowerLimit&&(t.linLower&&p.setLinearLowerLimit(r.fromArray(t.linLower).multiplyScalar(I.invScale)),t.linUpper&&p.setLinearUpperLimit(r.fromArray(t.linUpper).multiplyScalar(I.invScale))),p.setAngularLowerLimit&&(t.angLower&&p.setAngularLowerLimit(r.fromArray(t.angLower).multiplyScalar(k.torad)),t.angUpper&&p.setAngularUpperLimit(r.fromArray(t.angUpper).multiplyScalar(k.torad))),t.motor&&p.enableAngularMotor&&p.enableAngularMotor(t.motor[0],t.motor[1],t.motor[2]),t.feedback&&p.enableFeedback(t.feedback),t.angularOnly&&p.setAngularOnly&&p.setAngularOnly(t.angularOnly?1:0),t.enableMotor&&p.enableMotor&&p.enableMotor(t.enableMotor),t.maxMotorImpulse&&p.setMaxMotorImpulse&&p.setMaxMotorImpulse(t.maxMotorImpulse),t.motorTarget&&p.setMotorTarget&&(g=k.quaternion().fromArray(t.motorTarget),p.setMotorTarget(g),g.free()),t.damping&&p.setDamping)for(var u=0;u<6;u++)p.setDamping(u,t.damping[u]);if(t.spring&&p.enableSpring&&p.setStiffness){for(u=0;u<3;u++)0!==t.spring[u]?(p.enableSpring(u,!0),p.setStiffness(u,t.spring[u])):p.enableSpring(u,!1);for(u=0;u<3;u++)0!==t.spring[u]?(p.enableSpring(u+3,!0),p.setStiffness(u+3,t.spring[u])):p.enableSpring(u+3,!1)}if(t.param&&p.setParam)for(var u=0,y=t.param.length;u<y;u++)p.setParam(t.param[u][0],t.param[u][1],u);var g=void 0!==t.collision&&t.collision;p.isJoint=!0,p.name=e,p.nType=d,p.type="joint",I.world.addConstraint(p,!g),this.joints.push(p),q.set(e,p),r.free(),n.free(),a.free(),l.free(),c.free(),m.free(),h.free()}else console.log("! not find body")},applyOption:function(t,e){"joint_hinge"===e.type&&(e.limit&&(t.setLimit(e.limit[0]*k.torad,e.limit[1]*k.torad,void 0!==e.limit[2]?e.limit[2]:.9,void 0!==e.limit[3]?e.limit[3]:.3,void 0!==e.limit[4]?e.limit[4]:1),console.log("applyOption===joint_hinge==="+e.limit)),e.motor&&t.enableAngularMotor&&t.enableAngularMotor(e.motor[0],e.motor[1],e.motor[2]))}}),Object.assign(function(t){this.type="constraint",this.name=t.name}.prototype,{step:function(t,e){},init:function(t){},clear:function(){}}),Object.assign(L.prototype,{step:function(e,t){var i,o,s,r=t,n=I.scale;this.softs.forEach(function(t){for(o=t.get_m_nodes(),s=o.size();s--;)i=r+3*s,o.at(s).get_m_x().toArray(e,i,n);r+=3*o.size()})},getNodes:function(t){for(var e=[],i=t.get_m_nodes(),o=i.size(),s=0;s<o;s++)300<i.at(s).get_m_x().toArray()[1]&&e.push(s);return e},clear:function(){for(;0<this.softs.length;)this.destroy(this.softs.pop());this.ID=0},destroy:function(t){I.world.removeSoftBody(t),Ammo.destroy(t),q.delete(t.name)},remove:function(t){var e;q.has(t)&&(e=q.get(t),-1!=(t=this.softs.indexOf(e))&&(this.softs.splice(t,1),this.destroy(e)))},addAreo:function(t){if(q.has(t.soft)){for(var e=q.get(t.soft),i=k.vector3().fromeArray(t.wind),o=t.nodes.length;o--;)e.addAeroForceToNode(i,t.nodes[o]);i.free()}},addAnchor:function(t){if(q.has(t.soft)&&q.has(t.body))for(var e=t.collision||!1,i=q.get(t.soft),o=q.get(t.body),s=t.nodes.length;s--;)i.appendAnchor(t.nodes[s],o,!e,t.influence||1)},add:function(t){var e=void 0!==t.name?t.name:"soft"+this.ID++;this.remove(e);var i=I.world.getWorldInfo(),o=t.gendiags||!0;t.size=null==t.size?[1,1,1]:t.size,t.pos=void 0===t.pos?[0,0,0]:t.pos,t.quat=void 0===t.quat?[0,0,0,1]:t.quat,t.div=null==t.div?[64,64]:t.div,1!==I.scale&&(t.pos=k.vectomult(t.pos,I.invScale),t.size=k.vectomult(t.size,I.invScale));var s,r=k.vector3(),n=k.vector3(),a=k.vector3(),l=k.vector3(),c=k.vector3(),m=k.transform(),h=new Ammo.btSoftBodyHelpers;switch(t.type){case"softMesh":if(1!==I.scale)for(var p=t.v.length;p--;)t.v[p]*=I.invScale;(s=h.CreateFromTriMesh(i,t.v,t.i,t.ntri,t.randomize||!0)).softType=5;break;case"softCloth":var d=.5*t.size[0],f=.5*t.size[1];t.corners&&t.corners.enabled?(n.fromArray(t.corners.pos00),a.fromArray(t.corners.pos01),l.fromArray(t.corners.pos10),c.fromArray(t.corners.pos11)):"H"==t.direction.align?(n.fromArray([-d+t.pos[0],t.pos[1],-f+t.pos[2]]),a.fromArray([d+t.pos[0],t.pos[1],-f+t.pos[2]]),l.fromArray([-d+t.pos[0],t.pos[1],f+t.pos[2]]),c.fromArray([d+t.pos[0],t.pos[1],f+t.pos[2]])):"V_T"==t.direction.align?"X"==t.direction.face2?(n.fromArray([t.pos[0],t.pos[1]-f,t.pos[2]-d]),a.fromArray([t.pos[0],t.pos[1]-f,t.pos[2]+d]),l.fromArray([t.pos[0],t.pos[1]+f,t.pos[2]-d]),c.fromArray([t.pos[0],t.pos[1]+f,t.pos[2]+d])):"Z"==t.direction.face2&&(n.fromArray([t.pos[0]-d,t.pos[1]-f,t.pos[2]]),a.fromArray([t.pos[0]+d,t.pos[1]-f,t.pos[2]]),l.fromArray([t.pos[0]-d,t.pos[1]+f,t.pos[2]]),c.fromArray([t.pos[0]+d,t.pos[1]+f,t.pos[2]])):"V_B"==t.direction.align?"X"==t.direction.face2?(n.fromArray([t.pos[0],t.pos[1]+f,t.pos[2]+d]),a.fromArray([t.pos[0],t.pos[1]+f,t.pos[2]-d]),l.fromArray([t.pos[0],t.pos[1]-f,t.pos[2]+d]),c.fromArray([t.pos[0],t.pos[1]-f,t.pos[2]-d])):"Z"==t.direction.face2&&(n.fromArray([t.pos[0]+d,t.pos[1]+f,t.pos[2]]),a.fromArray([t.pos[0]-d,t.pos[1]+f,t.pos[2]]),l.fromArray([t.pos[0]+d,t.pos[1]-f,t.pos[2]]),c.fromArray([t.pos[0]-d,t.pos[1]-f,t.pos[2]])):"V_C"==t.direction.align&&("X"==t.direction.face2?(n.fromArray([t.pos[0],t.pos[1],t.pos[2]]),a.fromArray([t.pos[0],t.pos[1],t.pos[2]-2*d]),l.fromArray([t.pos[0],t.pos[1]-2*f,t.pos[2]]),c.fromArray([t.pos[0],t.pos[1]-2*f,t.pos[2]-2*d])):"Z"==t.direction.face2&&(n.fromArray([t.pos[0],t.pos[1],t.pos[2]]),a.fromArray([t.pos[0]-2*d,t.pos[1],t.pos[2]]),l.fromArray([t.pos[0],t.pos[1]-2*f,t.pos[2]]),c.fromArray([t.pos[0]-2*d,t.pos[1]-2*f,t.pos[2]]))),(s=h.CreatePatch(i,n,a,l,c,t.div[0],t.div[1],t.fixed||0,o)).softType=1;break;case"softRope":n.fromArray(t.start||[-10,0,0],0,I.invScale),a.fromArray(t.end||[10,0,0],0,I.invScale);f=t.numSegment||10;(s=h.CreateRope(i,n,a,f-=2,t.fixed||0)).softType=2;break;case"softEllips":n.fromArray(t.center||[0,0,0],0,I.invScale),a.fromArray(t.radius||[3,3,3],0,I.invScale),(s=h.CreateEllipsoid(i,n,a,t.vertices||128)).softType=3;for(var u,y=[],g=s.get_m_nodes(),p=g.size();p--;)v=3*p,u=g.at(p).get_m_x(),y[v]=u.x(),y[v+1]=u.y(),y[v+2]=u.z();t.lng=g.size(),t.a=y,self.postMessage({m:"ellipsoid",o:t});break;case"softConvex":for(var v,b=t.v.length/3,A=0,A=0;A<b;A++)v=3*A;var w=new Ammo.btConvexHullShape;for(A=0;A<b;A++)n.fromArray(t.v,v=3*A,I.invScale),w.addPoint(n);w.initializePolyhedralFeatures(),(s=h.CreateFromConvexHull(i,w.getConvexPolyhedron(),w.getConvexPolyhedron().m_vertices.size(),t.randomize||!1)).softType=4,console.log(s,s.get_m_nodes().size())}this.applyOption(s,t),m.identity().fromArray(t.pos.concat(t.quat)),s.transform(m),I.world.addSoftBody(s,t.group||1,t.mask||-1),s.setActivationState(t.state||4),s.points=s.get_m_nodes().size(),s.name=e,s.type="soft",this.softs.push(s),q.set(e,s),r.free(),n.free(),a.free(),l.free(),c.free(),m.free()},applyOption:function(t,e){var i=t.get_m_cfg();void 0!==e.viterations&&i.set_viterations(e.viterations),void 0!==e.piterations&&i.set_piterations(e.piterations),void 0!==e.diterations&&i.set_diterations(e.diterations),void 0!==e.citerations&&i.set_citerations(e.citerations),i.set_collisions(17),void 0!==e.friction&&i.set_kDF(e.friction),void 0!==e.damping&&i.set_kDP(e.damping),void 0!==e.pressure&&i.set_kPR(e.pressure),void 0!==e.drag&&i.set_kDG(e.drag),void 0!==e.lift&&i.set_kLF(e.lift),void 0!==e.volume&&i.set_kVC(e.volume),void 0!==e.matching&&i.set_kMT(e.matching),void 0!==e.hardness&&(i.set_kCHR(e.hardness),i.set_kKHR(e.hardness),i.set_kSHR(e.hardness),i.set_kAHR(e.hardness)),void 0!==e.timescale&&i.set_timescale(e.timescale),void 0!==e.maxvolume&&i.set_maxvolume(e.maxvolume);i=t.get_m_materials().at(0);void 0!==e.stiffness&&(i.set_m_kLST(e.stiffness),i.set_m_kAST(e.stiffness),i.set_m_kVST(e.stiffness)),void 0!==e.bendingConstraint&&t.generateBendingConstraints(e.bendingConstraint,i),t.setTotalMass(e.mass||0,e.fromfaces||!1),void 0!==e.cluster&&t.generateClusters(e.cluster,e.maxClusterIterations||8192),void 0!==e.restitution&&t.setRestitution(e.restitution),void 0!==e.rolling&&t.setRollingFriction(e.rolling),void 0!==e.flag&&t.setCollisionFlags(e.flag),void 0!==e.margin&&Ammo.castObject(t,Ammo.btCollisionObject).getCollisionShape().setMargin(e.margin*I.invScale)}}),Object.assign(P.prototype,{step:function(){for(var t=I.flow.terrain.length;t--;)this.setData(I.flow.terrain[t]);I.flow.terrain=[],this.terrains.forEach(function(t){t.update()})},clear:function(){for(;0<this.terrains.length;)this.destroy(this.terrains.pop());this.ID=0},destroy:function(t){I.world.removeCollisionObject(t.body),t.clear(),q.delete(t.name)},remove:function(t){var e;q.has(t)&&(e=q.get(t),-1!=(t=this.terrains.indexOf(e))&&(this.terrains.splice(t,1),this.destroy(e)))},setData:function(t){q.has(t.name)&&q.get(t.name).setData(t.heightData)},add:function(t){var e=void 0!==t.name?t.name:"terrain"+this.ID++;this.remove(e);var i=void 0===t.group?2:t.group,o=void 0===t.mask?-1:t.mask,t=new H(e,t);I.world.addCollisionObject(t.body,i,o),this.terrains.push(t),q.set(e,t)}}),Object.assign(H.prototype,{setData:function(t){this.tmpData=t,this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT,this.needsUpdate=!0},update:function(){this.needsUpdate&&(this.malloc(),this.needsUpdate=!1,this.tmpData=null)},clear:function(){Ammo.destroy(this.body),Ammo._free(this.dataHeap.byteOffset),this.body=null,this.data=null,this.tmpData=null,this.dataHeap=null},malloc:function(){null===this.data&&(this.data=Ammo._malloc(this.nDataBytes)),this.dataHeap=new Uint8Array(Ammo.HEAPU8.buffer,this.data,this.nDataBytes),this.dataHeap.set(new Uint8Array(this.tmpData.buffer))}}),Object.assign(G.prototype,{step:function(i,o){for(var t=I.flow.vehicle.length;t--;)this.setData(I.flow.vehicle[t]);I.flow.vehicle=[];var s=this.trans;this.cars.forEach(function(t,e){t.step(i,o+64*e,s),t.drive(I.key[e])})},control:function(t){q.has(t)&&q.get(t+"_constuctor").drive(I.key)},clear:function(){for(;0<this.cars.length;)this.destroy(this.cars.pop());this.ID=0},destroy:function(t){I.world.removeRigidBody(t.body),I.world.removeAction(t.chassis),Ammo.destroy(t.body),Ammo.destroy(t.chassis),q.delete(t.name+"_constuctor"),q.delete(t.name),q.delete(t.name+"_chassis")},remove:function(t){var e;q.has(t)&&(e=q.get(t),-1!=(t=this.cars.indexOf(e))&&(this.cars.splice(t,1),this.destroy(e)))},setData:function(t){q.has(t.name+"_constuctor")&&q.get(t.name+"_constuctor").setData(t)},add:function(t){var e=void 0!==t.name?t.name:"car"+this.ID++;this.remove(e),t.size=void 0===t.size?[2,.5,4]:t.size,void 0!==t.pos&&(t.pos=k.vectomult(t.pos,I.invScale)),void 0!==t.size&&(t.size=k.vectomult(t.size,I.invScale)),void 0!==t.massCenter&&(t.massCenter=k.vectomult(t.massCenter,I.invScale));var i=t.shapeType||"box",o={},o="mesh"==i?{type:"mesh",v:t.v,mass:1}:"convex"==i?{type:"convex",v:t.v}:{type:"box",size:t.size},o=I.makeShape(o);void 0!==t.v&&delete t.v;o=new E(e,t,o);I.world.addAction(o.chassis),I.world.addRigidBody(o.body),this.cars.push(o),q.set(e+"_constuctor",o),q.set(e,o.body),q.set(e+"_chassis",o.chassis)},applyOption:function(t,e){}}),Object.assign(E.prototype,{step:function(t,e,i){var o=I.scale;t[e]=this.chassis.getCurrentSpeedKmHour(),this.body.getMotionState().getWorldTransform(i),i.toArray(t,e+1,o);for(var s,r=this.data.nWheel;r--;)this.chassis.updateWheelTransform(r,!0),s=this.chassis.getWheelTransformWS(r),t[e+56+r]=this.chassis.getWheelInfo(r).get_m_raycastInfo().get_m_suspensionLength()*o,s.toArray(t,e+(s=8*(r+1))+1,o),0===r&&(t[e+s]=this.chassis.getWheelInfo(0).get_m_steering()),1===r&&(t[e+s]=this.chassis.getWheelInfo(1).get_m_steering()),2===r&&(t[e+s]=this.steering);t[e+62]=this.chassis.getWheelInfo(0).m_rotation,t[e+63]=this.chassis.getWheelInfo(1).m_rotation},drive:function(t){var e,i,o,s=this.data;0===t[0]?this.steering*=.9:this.steering-=s.incSteering*t[0],this.steering=k.clamp(this.steering,-s.maxSteering,s.maxSteering),0===t[1]?(this.motor=0,this.breaking=s.breaking):(this.motor-=s.acceleration*t[1],this.breaking=0),this.motor=k.clamp(this.motor,-s.engine,s.engine),3<s.nWheel&&(i=Math.atan2(e=2*this.wpos[2],(t=this.wpos[0])+(r=e/Math.tan(this.steering))),o=Math.atan2(e,r-t),r<0&&(i-=Math.PI,o-=Math.PI));for(var r,n=s.nWheel;n--;)s.nWheel<4?0===n&&this.chassis.setSteeringValue(this.steering,n):(0===n&&this.chassis.setSteeringValue(o,n),1===n&&this.chassis.setSteeringValue(i,n)),this.chassis.applyEngineForce(this.motor,n),this.chassis.setBrake(this.breaking,n);this.motor<1&&((r=this.body.getAngularVelocity()).multiplyArray(this.limitAngular),this.body.setAngularVelocity(r))},clear:function(){this.body=null,this.chassis=null},init:function(t,e){var i=this.data,o=k.transform(),s=k.vector3(),r=k.vector3(),n=k.vector3(),a=k.vector3();this.isRay=void 0===t.isRay||t.isRay,i.mass=void 0===t.mass?800:t.mass,t.massCenter=void 0===t.massCenter?[0,0,0]:t.massCenter,i.pos=void 0===t.pos?[0,0,0]:t.pos,i.quat=void 0===t.quat?[0,0,0,1]:t.quat,i.nWheel=t.nWheel||4,s.fromArray(t.massCenter).negate(),o.setIdentity(),o.setOrigin(s);var l=new Ammo.btCompoundShape;l.addChildShape(o,e),o.identity().fromArray(i.pos.concat(i.quat)),s.setValue(0,0,0),l.calculateLocalInertia(i.mass,s);var c,e=new Ammo.btDefaultMotionState(o),l=new Ammo.btRigidBodyConstructionInfo(i.mass,e,l,s);this.body=new Ammo.btRigidBody(l),this.body.name=this.name,this.body.isRigidBody=!0,this.body.isBody=!0,this.body.setActivationState(4),Ammo.destroy(l),this.isRay&&(c=new Ammo.btVehicleTuning,l=new Ammo.btDefaultVehicleRaycaster(I.world),this.chassis=new Ammo.btRaycastVehicle(c,this.body,l),this.chassis.setCoordinateSystem(0,1,2));var m=t.radius||.4,h=t.radiusBack||m,p=t.wPos||[1,0,1.6],p=k.vectomult(p,I.invScale);m*=I.invScale,h*=I.invScale,p[1]-=t.massCenter[1];for(var d,f,u=i.nWheel,y=t.decalYBack||0,g=0;g<u;g++)0===g&&(d=[p[0],p[1],p[2]],f=!0),1===g&&(d=[-p[0],p[1],p[2]],f=!0),2===g&&(f=!(d=[-p[0],p[1]+y,-p[2]])),3===g&&(f=!(d=[p[0],p[1]+y,-p[2]])),4===g&&(f=!(d=[-p[0],p[1]+y,-p[3]])),5===g&&(f=!(d=[p[0],p[1]+y,-p[3]])),2===u&&(0===g&&(d=[0,p[1],p[2]],f=!0),1===g&&(f=!(d=[0,p[1]+y,-p[2]]))),3===u&&(0===g&&(d=[0,p[1],p[2]],f=!0),1===g&&(f=!(d=[p[0],p[1]+y,-p[2]])),2===g&&(f=!(d=[-p[0],p[1]+y,-p[2]]))),r.fromArray(d),n.setValue(0,-1,0),a.setValue(-1,0,0),this.chassis.addWheel(r,n,a,1,f?m:h,c,f),this.chassis.setBrake(t.breaking||100,g),this.wheelRadius.push(f?m:h),this.transforms.push(this.chassis.getWheelTransformWS(g));this.wpos=p,this.setData(t),o.free(),s.free(),r.free(),n.free(),a.free()},setMass:function(t){var e=k.vector3();this.data.mass=t,e.setValue(0,0,0),this.body.getCollisionShape().calculateLocalInertia(this.data.mass,e),this.body.setMassProps(t,e),this.body.updateInertiaTensor(),e.free()},setPosition:function(){this.steering=0,this.breaking=0,this.motor=0;var t=k.transform();t.identity().fromArray(this.data.pos.concat(this.data.quat));var e=k.vector3().set(0,0,0);this.body.setAngularVelocity(e),this.body.setLinearVelocity(e),this.body.setWorldTransform(t),this.chassis.resetSuspension();for(var i=this.data.nWheel;i--;)this.chassis.updateWheelTransform(i,!0);t.free(),e.free()},setData:function(t){var e,i=this.data;for(e in void 0!==t.mass&&t.mass!==i.mass&&this.setMass(t.mass),t)void 0!==i[e]&&(i[e]=t[e]);this.body.setFriction(i.friction),this.body.setRestitution(i.restitution),this.body.setDamping(i.linear,i.angular),this.body.setRollingFriction(i.rolling),void 0!==t.limitAngular&&(this.limitAngular=t.limitAngular);var o=k.vector3();void 0!==t.linearFactor&&this.body.setLinearFactor(o.fromArray(t.linearFactor)),void 0!==t.angularFactor&&this.body.setAngularFactor(o.fromArray(t.angularFactor)),o.free(),i.autoSuspension&&(i.s_compression=2*i.compValue*(o=Math.sqrt(i.s_stiffness)),i.s_damping=2*i.dampValue*o);for(var s,r=i.nWheel;r--;)(s=this.chassis.getWheelInfo(r)).set_m_suspensionStiffness(i.s_stiffness),s.set_m_wheelsDampingCompression(i.s_compression),s.set_m_wheelsDampingRelaxation(i.s_damping),s.set_m_maxSuspensionTravelCm(100*i.s_travel*I.invScale),s.set_m_suspensionRestLength1(i.s_length*I.invScale),s.set_m_maxSuspensionForce(i.s_force),s.set_m_rollInfluence(i.w_roll),s.set_m_frictionSlip(i.w_friction),s.set_m_wheelsRadius(this.wheelRadius[r]);t.reset&&this.setPosition()},get:function(){self.postMessage({m:"carData",o:this.data})}}),Object.assign(Q.prototype,{step:function(i,o){this.heroes.forEach(function(t,e){t.step(i,o+8*e),0!=I.key.length&&t.move(I.key[e])})},control:function(t){q.has(t)&&(t=q.get(t),I.key&&t.move(I.key))},clear:function(){for(;0<this.heroes.length;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(t){I.world.removeCollisionObject(t.body),I.world.removeAction(t.controller),t.clear(),q.delete(t.name)},remove:function(t){var e;q.has(t)&&(e=q.get(t),-1!=(t=this.heroes.indexOf(e))&&(this.heroes.splice(t,1),this.destroy(e)))},add:function(t){var e=void 0!==t.name?t.name:"hero"+this.ID++;this.remove(e);var i=new U(e,t);I.world.addCollisionObject(i.body,t.group||1,t.mask||-1),I.world.addAction(i.controller),this.heroes.push(i),q.set(e,i)}}),Object.assign(U.prototype,{isCharacter:!0,step:function(t,e){t[e]=this.controller.onGround()?1:0,this.body.getWorldTransform().toArray(t,e+1,I.scale)},move:function(t){var e,i,o=.05,o=1==t[7]?.1:1==t[5]?.02:.05;1==t[6]&&this.controller.canJump(),!this.wasJumping&&this.controller.onGround()&&(this.verticalVelocity=0,this.wasJumping=1==t[6]),0==t[6]&&this.wasJumping&&(this.verticalVelocity+=.04,.5<this.verticalVelocity&&(this.verticalVelocity=0,this.wasJumping=!1)),this.speed=(i=o*-t[1])+(e=o*-t[4]),this.angle-=.03*t[0],this.setAngle(this.angle),this.position.setValue(e,0+this.verticalVelocity,i),this.position.direction(this.q),this.controller.setWalkDirection(this.position)},clear:function(){Ammo.destroy(this.body),Ammo.destroy(this.controller),this.body=null,this.controller=null},init:function(t){var e=k.vector3(),i=k.transform();t.size=null==t.size?[1,1,1]:t.size,t.pos=null==t.pos?[0,0,0]:t.pos,t.quat=null==t.quat?[0,0,0,1]:t.quat,1!==I.scale&&(t.pos=k.vectomult(t.pos,I.invScale),void 0!==t.masscenter&&(t.masscenter=k.vectomult(t.masscenter,I.invScale)));var o=I.makeShape(t.shapeInfo||{type:"capsule",size:t.size}),s=new Ammo.btPairCachingGhostObject;i.identity().fromArray(t.pos.concat(t.quat)),s.setWorldTransform(i),s.setCollisionShape(o),s.setCollisionFlags(16),s.setFriction(t.friction||.1),s.setRestitution(t.restitution||0),s.setActivationState(4),s.activate(),this.body=s;i=new Ammo.btKinematicCharacterController(s,o,t.stepH||.35,t.upAxis||1);i.setUseGhostSweepTest(o),e.setValue(0,0,0),i.setVelocityForTimeInterval(e,1),this.controller=i,this.applyOption(t),this.setAngle(0),console.log(i,s)},applyOption:function(t){var e=this.controller;void 0!==t.gravity&&e.setGravity(t.gravity),void 0!==t.upAxis&&e.setUpAxis(t.upAxis),void 0!==t.canJump&&e.canJump(t.canJump),void 0!==t.maxJumpHeight&&e.setMaxJumpHeight(t.maxJumpHeight),void 0!==t.jumpSpeed&&e.setJumpSpeed(t.jumpSpeed),void 0!==t.fallSpeed&&e.setFallSpeed(t.fallSpeed),void 0!==t.slopeRadians&&e.setMaxSlope(t.slopeRadians),void 0!==t.angle&&this.setAngle(t.angle),void 0!==t.position&&(this.position.fromArray(t.position,0,I.invScale),this.position.direction(this.q),e.setWalkDirection(this.position)),void 0!==t.pos&&this.setPosition(t)},setPosition:function(t){var e=k.vector3();t.pos=k.vectomult(t.pos,I.invScale),e.fromArray(t.pos),this.controller.getGhostObject().getWorldTransform().setOrigin(e),e.free()},setAngle:function(t){var e=this.body.getWorldTransform();this.q.setFromAxisAngle([0,1,0],t),e.setRotation(this.q),this.angle=t}}),Object.assign(J.prototype,{step:function(i,o){var s;this.pairs.forEach(function(t,e){s=o+e,void(t.result=0)!==t.b?I.world.contactPairTest(t.a,t.b,t.f):I.world.contactTest(t.a,t.f),i[s]=t.result})},clear:function(){for(;0<this.pairs.length;)this.destroy(this.pairs.pop());this.ID=0},destroy:function(t){t.clear(),q.delete(t.name)},remove:function(t){var e;q.has(t)&&(e=q.get(t),-1!=(t=this.pairs.indexOf(e))&&(this.pairs.splice(t,1),this.destroy(e)))},add:function(t){var e=void 0!==t.name?t.name:"pair"+this.ID++;q.has(t.b1)&&(t=new X(q.get(t.b1),void 0!==t.b2&&q.has(t.b2)?q.get(t.b2):void 0,e),this.pairs.push(t),q.set(e,t))}}),Object.assign(X.prototype,{clear:function(){this.a=null,this.b=null,Ammo.destroy(this.f)}}),Object.assign(Y.prototype,{step:function(){if(null!==this.ray){var t=this.rays.length,e=I.flow.ray.length;if(t){if(t===e)for(;e--;)this.rays[e].update(I.flow.ray[e]);I.flow.ray=[];var s=this.ray;this.rays.forEach(function(t,e){var i,o;s.set_m_closestHitFraction(t.precision),s.set_m_collisionObject(null),s.get_m_rayFromWorld().fromArray(t.origin,0,I.invScale),s.get_m_rayToWorld().fromArray(t.dest,0,I.invScale),s.set_m_collisionFilterGroup(t.group),s.set_m_collisionFilterMask(t.mask),I.world.rayTest(s.get_m_rayFromWorld(),s.get_m_rayToWorld(),s),s.hasHit()?(void 0===(i=Ammo.castObject(s.get_m_collisionObject(),Ammo.btRigidBody).name)&&(i=Ammo.castObject(s.get_m_collisionObject(),Ammo.btSoftBody).name),(o=s.get_m_hitNormalWorld()).normalize(),t.result.hit=!0,t.result.name=i,t.result.point=s.get_m_hitPointWorld().toArray(void 0,0,I.scale),t.result.normal=o.toArray()):(t.result.hit=!1,t.result.name=""),I.flow.ray.push(t.result)})}}},update:function(t){var e=this.rays.length;if(e&&e===t.length)for(;e--;)this.rays[e].update(t[e])},clear:function(){for(;0<this.rays.length;)this.destroy(this.rays.pop());this.ID=0},destroy:function(t){t.clear(),q.delete(t.name)},remove:function(t){var e;q.has(t)&&(e=q.get(t),-1!=(t=this.rays.indexOf(e))&&(this.rays.splice(t,1),this.destroy(e)))},add:function(t){null===this.ray&&(this.ray=new Ammo.ClosestRayResultCallback);var e=void 0!==t.name?t.name:"ray"+this.ID++;this.remove(t.name);t=new Z(e,t);this.rays.push(t),q.set(e,t)}}),Object.assign(Z.prototype,{update:function(t){this.precision=t.precision||1,this.origin=t.origin||[0,0,0],this.dest=t.dest||[0,1,0],this.group=void 0!==t.group?t.group:1,this.mask=void 0!==t.mask?t.mask:-1},clear:function(){}}),self.onmessage=function(t){t=t.data;t.Ar&&i.engine.setAr(t.Ar),t.flow&&(I.flow=t.flow),i.engine[t.m](t.o)},i.engine=(A=null,w=!1,_="undefined"==typeof performance?Date:performance,x=3*(S=1/60),z=!1,V=T=O=!(M=2),F=[],D=null,j={now:R=C=0,delta:0,then:0,deltaTime:0,inter:0,tmp:0,n:0,timerate:0,last:0},i.engine={test:function(){},setAr:function(t){o=t},getAr:function(){return o},setDrive:function(t){},setMove:function(t){},setAngle:function(t){I.angle=t.angle},internStep:function(t){I.key=t.key,j.last=_.now(),A&&clearInterval(A),A=setInterval(function(){j.now=_.now(),i.engine.step({delta:.001*(j.now-j.last)}),j.last=j.now},1e3*S),console.log("is interne update")},step:function(t){w?(j.tmp<j.now-1e3&&(j.tmp=j.now,j.fps=j.n,j.n=0),j.n++):I.key=t.key,C=t.delta,this.stepRemove(),this.stepMatrix(),this.stepOptions(),this.stepForces(),f.step(),0!==R&&this.stepBreak(),z?I.world.stepSimulation(S,0):I.world.stepSimulation(C,M,S),h.step(o,s[0]),v.step(o,s[1]),g.step(o,s[2]),y.step(o,s[3]),p.step(o,s[4]),V&&d.step(o,s[5]),b.step(),I.flow.key=t.key,O?self.postMessage({m:"step",fps:j.fps,delta:j.delta,flow:I.flow,Ar:o},[o.buffer]):self.postMessage({m:"step",fps:j.fps,delta:C,flow:I.flow,Ar:o})},clearFlow:function(){I.flow={ray:[],terrain:[],vehicle:[]}},reset:function(t){R=0,this.clearFlow(),F=[],I.matrix=[],I.option=[],I.force=[],h.clear(),d.clear(),p.clear(),f.clear(),y.clear(),g.clear(),v.clear(),b.clear(),q.clear(),k.destroy(),t.full&&(this.clearWorld(),this.createWorld()),this.setGravity(),O||(o=new Float32Array(r)),self.postMessage({m:"start"})},addMulty:function(t){for(var e=0,i=t.length;e<i;e++)this.add(t[e])},post:function(t,e){self.postMessage({m:t,o:e})},init:function(e){O=e.isBuffer||!1,s=e.ArPos,r=e.ArMax,O||(o=new Float32Array(r)),importScripts(e.blob),Ammo().then(function(t){Ammo.btTransform.prototype=Object.assign(Object.create(Ammo.btTransform.prototype),{identity:function(){return this.setIdentity(),this},positionFromArray:function(t,e,i){e=e||0;i=k.vector3().fromArray(t,e,i);return this.setOrigin(i),i.free(),this},eulerFromArray:function(t,e){e=e||0;e=k.quaternion().setFromEuler(t,e);return this.setRotation(e),e.free(),this},eulerFromArrayZYX:function(t,e){return e=e||0,this.getBasis().setEulerZYX(t[e],t[e+1],t[e+2]),this},getRow:function(t){return this.getBasis().getRow(t)},makeRotationDir:function(t){var e=k.vector3().fromArray(t),i=k.vector3(0,1,0),o=k.vector3().cross(i,e).normalize(),s=k.vector3().cross(e,o).normalize(),r=k.matrix3(),t=r.setV3(o,s,e).toQuaternion().normalize();this.setRotation(t),r.free(),t.free(),e.free(),i.free(),o.free(),s.free()},setFromDirection:function(t){var e=k.vector3().fromArray(t),i=k.vector3(),o=k.quaternion();return.99999<e.y()?o.set(0,0,0,1):e.y()<-.99999?o.set(1,0,0,0):(i.set(e.z(),0,-e.x()),t=Math.acos(e.y()),o.setFromAxisAngle(i.toArray(),t)),this.setRotation(o),e.free(),i.free(),o.free(),this},quartenionFromAxis:function(t){t=k.quaternion().setFromAxis(t);return this.setRotation(t),t.free(),this},quartenionFromAxisAngle:function(t,e){e=k.quaternion().setFromAxisAngle(t,e);return this.setRotation(e),e.free(),this},quaternionFromArray:function(t,e){e=e||0;e=k.quaternion().fromArray(t,e);return this.setRotation(e),e.free(),this},fromArray:function(t,e,i){return this.positionFromArray(t,e=e||0,i),3<t.length&&this.quaternionFromArray(t,e+3),this},toArray:function(t,e,i){e=e||0,this.getOrigin().toArray(t,e,i),this.getRotation().toArray(t,e+3)},getInverse:function(){var t=k.transform();t.setIdentity();var e=this.getRotation().toMatrix3().transpose(),i=this.getOrigin().clone().negate(),o=e.multiplyByVector3(i),s=e.toQuaternion();return t.setOrigin(o),t.setRotation(s),i.free(),o.free(),s.free(),e.free(),t},multiply:function(t){var e=this.getRotation().toMatrix3(),i=t.getRotation().toMatrix3(),o=this.getOrigin().clone(),s=t.getOrigin().clone(),r=e.multiplyByVector3(s).add(o);this.setOrigin(r),e.multiply(i);t=e.toQuaternion();return this.setRotation(t),e.free(),i.free(),o.free(),s.free(),t.free(),r.free(),this},clone:function(){var t=k.transform();return t.setIdentity(),t.setOrigin(this.getOrigin()),t.setRotation(this.getRotation()),t},copy:function(t){return this.setOrigin(t.getOrigin()),this.setRotation(t.getRotation()),this},free:function(){k.freeTransform(this)}}),Ammo.btVector3.prototype=Object.assign(Object.create(Ammo.btVector3.prototype),{set:function(t,e,i){return this.setValue(t,e,i),this},zero:function(){return this.setValue(0,0,0),this},negate:function(){return this.setValue(-this.x(),-this.y(),-this.z()),this},add:function(t){return this.setValue(this.x()+t.x(),this.y()+t.y(),this.z()+t.z()),this},sub:function(t){return this.setValue(this.x()-t.x(),this.y()-t.y(),this.z()-t.z()),this},dot:function(t){return this.x()*t.x()+this.y()*t.y()+this.z()*t.z()},cross:function(t,e){var i=t.x(),o=t.y(),s=t.z(),r=e.x(),t=e.y(),e=e.z();return this.set(o*e-s*t,s*r-i*e,i*t-o*r),this},multiplyScalar:function(t){return this.setValue(this.x()*t,this.y()*t,this.z()*t),this},multiplyArray:function(t){return this.setValue(this.x()*t[0],this.y()*t[1],this.z()*t[2]),this},fromArray:function(t,e,i){return this.setValue(t[e=e||0]*(i=i||1),t[e+1]*i,t[e+2]*i),this},divideScalar:function(t){return this.multiplyScalar(1/t)},length:function(){return Math.sqrt(this.x()*this.x()+this.y()*this.y()+this.z()*this.z())},normalize:function(){return this.divideScalar(this.length()||1)},toArray:function(t,e,i){return i=i||1,(t=void 0===t?[]:t)[e=void 0===e?0:e]=this.x()*i,t[e+1]=this.y()*i,t[e+2]=this.z()*i,t},direction:function(t){var e=t.x(),i=t.y(),o=t.z(),s=t.w(),r=this.x(),n=this.y(),a=this.z(),l=s*r+i*a-o*n,c=s*n+o*r-e*a,t=s*a+e*n-i*r,a=-e*r-i*n-o*a;return this.setValue(l*s+a*-e+c*-o-t*-i,c*s+a*-i+t*-e-l*-o,t*s+a*-o+l*-i-c*-e),this},clone:function(){return k.vector3().set(this.x(),this.y(),this.z())},free:function(){k.freeVector3(this)}}),Ammo.btQuaternion.prototype=Object.assign(Object.create(Ammo.btQuaternion.prototype),{set:function(t,e,i,o){return this.setValue(t,e,i,o),this},fromArray:function(t,e){return this.setValue(t[e=void 0===e?0:e],t[e+1],t[e+2],t[e+3]),this},toArray:function(t,e){return(t=void 0===t?[]:t)[e=void 0===e?0:e]=this.x(),t[e+1]=this.y(),t[e+2]=this.z(),t[e+3]=this.w(),t},setFromAxis:function(t){return.99999<t[2]?this.setValue(0,0,0,1):t[2]<-.99999?this.setValue(1,0,0,0):this.setFromAxisAngle([t[1],t[0],0],Math.acos(t[2])),this},setFromAxisAngle:function(t,e){var i=.5*e,e=Math.sin(i);return this.setValue(t[0]*e,t[1]*e,t[2]*e,Math.cos(i)),this},setFromEuler:function(t){var e,i,o,s,r=t[0],n=t[1],a=t[2],l=t[3]||"XYZ",c=Math.cos,m=Math.sin,h=c(.5*r),t=c(.5*n),c=c(.5*a),r=m(.5*r),n=m(.5*n),a=m(.5*a);return"XYZ"===l?(e=r*t*c+h*n*a,i=h*n*c-r*t*a,o=h*t*a+r*n*c,s=h*t*c-r*n*a):"YXZ"===l?(e=r*t*c+h*n*a,i=h*n*c-r*t*a,o=h*t*a-r*n*c,s=h*t*c+r*n*a):"ZXY"===l?(e=r*t*c-h*n*a,i=h*n*c+r*t*a,o=h*t*a+r*n*c,s=h*t*c-r*n*a):"ZYX"===l?(e=r*t*c-h*n*a,i=h*n*c+r*t*a,o=h*t*a-r*n*c,s=h*t*c+r*n*a):"YZX"===l?(e=r*t*c+h*n*a,i=h*n*c+r*t*a,o=h*t*a-r*n*c,s=h*t*c-r*n*a):"XZY"===l&&(e=r*t*c-h*n*a,i=h*n*c-r*t*a,o=h*t*a+r*n*c,s=h*t*c+r*n*a),this.setValue(e,i,o,s),this},toMatrix3:function(){var t=[],e=this.x(),i=this.y(),o=this.z(),s=this.w(),r=e*e,n=i*i,a=o*o,l=e*i,c=i*o,m=o*e,e=e*s,i=i*s,s=o*s;return t[0]=1-2*(n+a),t[1]=2*(l-s),t[2]=2*(m+i),t[3]=2*(l+s),t[4]=1-2*(a+r),t[5]=2*(c-e),t[6]=2*(m-i),t[7]=2*(c+e),t[8]=1-2*(r+n),k.matrix3().fromArray(t)},length:function(){return Math.sqrt(this.x()*this.x()+this.y()*this.y()+this.z()*this.z()+this.w()*this.w())},normalize:function(){var t=this.length();return 0===t?this.set(0,0,0,1):(t=1/t,this.set(this.x()*t,this.y()*t,this.z()*t,this.w()*t))},multiply:function(t){return this.multiplyQuaternions(this,t)},multiplyQuaternions:function(t,e){var i=t.x(),o=t.y(),s=t.z(),r=t.w(),n=e.x(),a=e.y(),t=e.z(),e=e.w();return this.set(i*e+r*n+o*t-s*a,o*e+r*a+s*n-i*t,s*e+r*t+i*a-o*n,r*e-i*n-o*a-s*t),this},clone:function(){return k.quaternion().set(this.x(),this.y(),this.z(),this.w())},free:function(){k.freeQuaternion(this)}}),i.engine.createWorld(e.option),i.engine.set(e.option),h=new W,d=new B,p=new L,f=new P,y=new G,g=new Q,v=new J,b=new Y,new t.ClosestRayResultCallback,c=k.transform(),m=k.vector3(),I.makeShape=function(t){return h.add(t,"isShape")},self.postMessage({m:"initEngine"})})},remove:function(t){if(q.has(t))switch(q.get(t).type){case"solid":case"body":h.remove(t);break;case"soft":p.remove(t);break;case"terrain":f.remove(t);break;case"joint":case"constraint":d.remove(t);break;case"collision":v.remove(t);break;case"ray":b.remove(t)}},setRemove:function(t){F=F.concat(t)},stepRemove:function(){for(;0<F.length;)this.remove(F.pop())},directRemoves:function(t){this.setRemove(t),this.stepRemove()},add:function(t){t.type=void 0===t.type?"box":t.type,void 0!==t.breakable&&t.breakable&&R++;var e=t.type,i=t.type.substring(0,4);("join"==i?d:"soft"==i||"ellipsoid"===e?p:"terrain"===e?f:"character"===e?g:"collision"===e?v:"ray"===e?b:"car"===e?y:h).add(t)},addAnchor:function(t){p.addAnchor(t)},setVehicle:function(t){y.setData(t)},createWorld:function(t){if(null===I.world){switch(t=t||{},(D=new Ammo.btVector3).set(0,0,0),T=void 0===t.soft||t.soft,e=new Ammo.btSequentialImpulseConstraintSolver,n=T?new Ammo.btDefaultSoftBodySolver:null,a=new(T?Ammo.btSoftBodyRigidBodyCollisionConfiguration:Ammo.btDefaultCollisionConfiguration),u=new Ammo.btCollisionDispatcher(a),void 0===t.broadphase?2:t.broadphase){case 1:l=new Ammo.btAxisSweep3(new Ammo.btVector3(-1e3,-1e3,-1e3),new Ammo.btVector3(1e3,1e3,1e3),4096);break;case 2:l=new Ammo.btDbvtBroadphase}I.world=T?new Ammo.btSoftRigidDynamicsWorld(u,l,e,a,n):new Ammo.btDiscreteDynamicsWorld(u,l,e,a),I.post=this.post}else console.error("World already existe !!")},clearWorld:function(){Ammo.destroy(I.world),Ammo.destroy(e),null!==n&&Ammo.destroy(n),Ammo.destroy(a),Ammo.destroy(u),Ammo.destroy(l),I.world=null},setWorldscale:function(t){I.scale=t,I.invScale=1/t},setGravity:function(t){t=t||{},I.gravity=new Ammo.btVector3,I.gravity.fromArray(void 0!==t.gravity?t.gravity:[0,-9.81,0]),I.world.setGravity(I.gravity),T&&I.world.getWorldInfo().set_m_gravity(I.gravity)},set:function(t){this.setWorldscale(void 0!==(t=t||{}).worldscale?t.worldscale:1),S=void 0!==t.fps?1/t.fps:1/60,M=void 0!==t.substep?t.substep:2,z=void 0!==t.fixed&&t.fixed,j.inter=void 0!==t.fps?1e3/t.fps:1e3/60,w=t.isInternUpdate||!1,V=void 0!==t.jointDebug&&t.jointDebug,I.constraintDebug=V,x=3*S,void 0!==t.penetration&&I.world.getDispatchInfo().set_m_allowedCcdPenetration(t.penetration),this.setGravity(t)},setForces:function(t){I.force=I.force.concat(t)},directForces:function(t){this.setForces(t),this.stepForces()},stepForces:function(){for(var t=I.force.length;t--;)this.applyForces(I.force[t]);I.force=[]},applyForces:function(t){var e=t.name;if(q.has(e)){var i=q.get(e),o=k.vector3(),s=k.vector3(),e=k.quaternion();switch(void 0!==t.direction&&o.fromArray(k.vectomult(t.direction,I.invScale)),void 0!==t.distance?s.fromArray(k.vectomult(t.distance,I.invScale)):s.zero(),t.type){case"force":case 0:i.applyForce(o,s);break;case"torque":case 1:i.applyTorque(o);break;case"localTorque":case 2:i.applyLocalTorque(o);break;case"forceCentral":case 3:i.applyCentralForce(o);break;case"forceLocal":case 4:i.applyCentralLocalForce(o);break;case"impulse":case 5:i.applyImpulse(o,s);break;case"impulseCentral":case 6:i.applyCentralImpulse(o);break;case"motor":case 7:i.enableAngularMotor(t.enable||!0,t.targetVelocity,t.maxMotor);break;case"motorTarget":case 8:i.setMotorTarget(t.target,t.axis||-1);case"setLimit":case 9:i.setLimit(t.limit[0]*k.torad,t.limit[1]*k.torad,t.limit[2]||.9,t.limit[3]||.3,t.limit[4]||1)}o.free(),s.free(),e.free()}},setMatrix:function(t){I.matrix=I.matrix.concat(t)},directMatrix:function(t){this.setMatrix(t),this.stepMatrix()},stepMatrix:function(){for(var t=I.matrix.length;t--;)this.applyMatrix(I.matrix[t]);I.matrix=[]},applyMatrix:function(t){var e,i,o,s,r=t.name;q.has(r)&&((e=q.get(r)).isCharacter?e.setMatrix(t):(s=c.identity(),i=m,void 0===t.rot&&void 0===t.quat&&(t.quat=[0,0,0,1]),(t.keepX||t.keepY||t.keepZ||t.keepRot)&&(e.getMotionState().getWorldTransform(s),s.toArray(o=[]),void 0!==t.keepX&&(t.pos[0]=o[0]-t.pos[0]),void 0!==t.keepY&&(t.pos[1]=o[1]-t.pos[1]),void 0!==t.keepZ&&(t.pos[2]=o[2]-t.pos[2]),void 0!==t.keepRot&&(t.quat=[o[3],o[4],o[5],o[6]])),void 0!==t.pos&&(void 0!==t.rot&&(t.quat=k.eulerToQuadArray(t.rot,!0)),t.pos=t.pos.concat(t.quat),s.fromArray(t.pos,0,I.invScale),(e.isKinematic?e.getMotionState():e).setWorldTransform(s)),void 0!==t.clamped&&(s=x<C?1:C/x,i.fromArray(t.pos,0,I.invScale).sub(e.getWorldTransform().getOrigin()).multiplyScalar(s),e.setLinearVelocity(i)),t.velocity&&!e.isGhost&&(t.velocity[0]&&e.setLinearVelocity(i.fromArray(t.velocity[0],0,I.invScale)),t.velocity[1]&&e.setAngularVelocity(i.fromArray(t.velocity[1]))),t.noVelocity&&!e.isGhost&&(e.setLinearVelocity(D),e.setAngularVelocity(D)),t.noGravity&&e.setGravity(D),t.activate&&e.activate(),"body"!==e.type||e.isKinematic||e.activate(),"solid"===e.type&&self.postMessage({m:"moveSolid",o:{name:r,pos:t.pos,quat:t.quat}})))},setOptions:function(t){I.option=I.option.concat(t)},directOptions:function(t){this.setOptions(t),this.stepOptions()},stepOptions:function(){for(var t=I.option.length;t--;)this.applyOption(I.option[t]);I.option=[]},applyOption:function(t){var e=t.name;if("join"==(void 0===t.type?"box":t.type).substring(0,4)){var i=q.get(e);d.applyOption(i,t)}else if(q.has(e)){var o=q.get(e);switch(o.type){case"solid":case"body":h.applyOption(o,t);break;case"soft":p.applyOption(o,t);break;case"character":o.applyOption(t)}}},stepBreak:function(){for(var t,e,i,o,s,r,n,a,l,c=0,m=u.getNumManifolds();c<m;c++)if(t=u.getManifoldByIndexInternal(c),a=Ammo.castObject(t.getBody0(),Ammo.btRigidBody),l=Ammo.castObject(t.getBody1(),Ammo.btRigidBody),r=a.name,n=l.name,a.breakable||l.breakable){for(var h=!1,p=0,d=0,f=t.getNumContacts();d<f;d++)if((e=t.getContactPoint(d)).getDistance()<0){h=!0,p<(i=e.getAppliedImpulse())&&(p=i,o=e.get_m_positionWorldOnB().toArray(),s=e.get_m_normalWorldOnB().toArray());break}h&&(a.breakable&&a.breakOption[0]<p&&self.postMessage({m:"makeBreak",o:{name:r,pos:k.vectomult(o,I.scale),normal:s,breakOption:a.breakOption}}),l.breakable&&l.breakOption[0]<p&&self.postMessage({m:"makeBreak",o:{name:n,pos:k.vectomult(o,I.scale),normal:s,breakOption:l.breakOption}}))}}},i.engine),Object.defineProperty(i,"__esModule",{value:!0})});
